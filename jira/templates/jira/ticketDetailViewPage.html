{% extends "accounts/base.html" %}
{% load static %}
{% block content %}

    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <link type="text/css" rel="stylesheet" href="{% static 'css/ticketPageCss1.css' %}" media="all">
    <link type="text/css" rel="stylesheet" href="{% static 'css/ticketPageCss2.css' %}" media="all">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css">

    <style>
    .file-drop-area {
            position: relative;
            display: flex;
            align-items: center;
            width: 450px;
            max-width: 100%;
            padding: 25px;
            border: 1px dashed rgba(255, 255, 255, 0.4);
            border-radius: 3px;
            transition: 0.2s;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            cursor: pointer;
            opacity: 0;
        }
    </style>

    <div class="modal fade bd-example-modal-lg" id="editTicketModal" tabindex="-1" role="dialog"
         aria-labelledby="myLargeModalLabel" aria-hidden="true" style="color: black;">
        <div class="modal-dialog" role="document" style="max-width: 1000px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Edit Issue: {{ ticket.internalKey }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="project-add-details" role="tabpanel">
                                <dl class="row">
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Summary</label>
                                        <input class="form-control col" type="text" placeholder="Summary" name="summary"
                                               value="{{ ticket.summary }}"
                                               required>
                                    </dd>
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Issue type</label>
                                        <select id="ticketIssueType" data-show-content="true"
                                                class="form-control" name="ticketIssueType">
                                            {% for it in ticketIssueTypes %}
                                                <option data-content="<img src='{{ it.icon }}' width='20' height='20'>&nbsp; {{ it.internalKey }}"
                                                        {% if it.code == ticket.issueType.code %}
                                                        selected="selected" {% endif %}
                                                        value="{{ it.id }}">{{ it.internalKey }}</option>
                                            {% endfor %}
                                        </select>
                                    </dd>
                                </dl>
                                <hr>
                                <dl class="row">
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Priority</label>
                                        <select id="ticketPriorities" data-show-content="true"
                                                class="form-control" name="priority">
                                            {% for tp in ticketPriorities %}
                                                <option data-content="<img src='{{ tp.icon }}' width='20' height='20'>&nbsp; {{ tp.internalKey }}"
                                                        {% if tp.code == ticket.priority.code %}
                                                        selected="selected" {% endif %}
                                                        value="{{ tp.id }}">{{ tp.internalKey }}</option>
                                            {% endfor %}
                                        </select>
                                    </dd>
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Components</label>
                                        <select class="form-control select2bs4" multiple="multiple" name="components" id="ticket-components"
                                                style="width: 100%">
                                            {% for component in projectComponents %}
                                                <option value="{{ component.id }}">{{ component.internalKey }}</option>
                                            {% endfor %}

                                        </select>
                                    </dd>
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Labels</label>
                                        <select class="form-control ticketLabels" multiple="multiple" name="labels"
                                                id="ticketLabels"
                                                style="width: 100%">
                                            {% for label in labels %}
                                                <option value="{{ label.internalKey }}">{{ label.internalKey }}</option>
                                            {% endfor %}
                                        </select>
                                    </dd>
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Story Points</label>
                                        <input class="form-control col" type="number" placeholder="Story Points"
                                               name="storyPoints" value="{{ ticket.storyPoints }}">
                                    </dd>
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Fix Version</label>
                                        <input class="form-control col" type="text" placeholder="Fix Version"
                                               name="fixVersion" value="{{ ticket.fixVersion }}">
                                    </dd>
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Attachment</label>
                                        <div class="file-drop-area border justify-content-center" style="width: 100%;">
                                            <span class="choose-file-button">Choose files </span>
                                            <span class="file-message"> or drag and drop files here</span>
                                            <input class="file-input" name="attachments" type="file" multiple>
                                        </div>
                                    </dd>
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Description</label>
                                        <textarea class="form-control col" rows="5" name="description"
                                                  required>{{ ticket.description }}</textarea>
                                    </dd>
                                </dl>
                                <hr>
                                <dl class="row">
                                    <dd class="col-sm-12">
                                        <label style="font-size: 85%; color: #6c757d;">Assignee</label>
                                        <select id="assignee" data-show-content="true" class="form-control"
                                                name="assignee">
                                            {% for p in profiles %}

                                                <option data-content="<img src='{{ p.profilePicture.url }}' width='20' height='20'>&nbsp; {{ p.user.get_full_name }}"
                                                        {% if p.user.id == ticket.assignee.id %}
                                                        selected="selected" {% endif %}
                                                        value="{{ p.user.id }}">{{ p.user.get_full_name }}</option>

                                            {% endfor %}
                                        </select>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input class="btn btn-primary" type="submit" style="background-color: #0052cc" value="Update">
                        <button class="btn btn-secondary" type="reset" data-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="issue-content" class="issue-edit-form">
    </div>

    <script type="text/javascript">

        $('.select2bs4').select2({});
        let ticketLabels = $('#ticketLabels').select2({
            tags: true,
        });

        const componentsLabel = [];
        const labels = [];

        {% for component in ticket.components %}
            componentsLabel.push('{{ component.id }}')
        {% endfor %}

        {% for label in ticket.labels %}
            labels.push('{{ label.internalKey }}')
        {% endfor %}

        labels.forEach(function (e) {
            if (!ticketLabels.find('option:contains(' + e + ')').length)
                ticketLabels.append($('<option>').text(e));
        });

        $('#ticket-components').select2().val(componentsLabel).trigger("change");

        ticketLabels.val(labels).trigger("change");
    </script>


    <script type="text/babel">

        class TicketHeaderComponent extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {
                const style1 = {
                    backgroundColor: '#f5f6f8'
                }
                return (
                    <header id="stalker" className="issue-header js-stalker">
                        <div className="issue-header-content">
                            <div className="aui-page-header">
                                <div className="aui-page-header-inner">
                                    <div className="aui-page-header-image">
                                <span id="10172" className="aui-avatar aui-avatar-large aui-avatar-project">
                                    <span className="aui-avatar-inner">
                                        <img id="project-avatar"
                                             alt={"Uploaded image for project: " + this.props.ticket.project.internalKey}
                                             src={this.props.ticket.project.icon}></img>
                                    </span>
                                </span>
                                    </div>
                                    <div className="aui-page-header-main">
                                        <ol className="aui-nav aui-nav-breadcrumbs" resolved="">
                                            <li>
                                                <a id="project-name-val"
                                                   href={this.props.ticket.project.link}
                                                   className="">{this.props.ticket.project.internalKey}</a>
                                            </li>
                                            &nbsp;
                                            <li>
                                                <a className="issue-link" data-issue-key={this.props.ticket.link}
                                                   href={this.props.ticket.link} id="key-val"
                                                   rel="215653">{this.props.ticket.internalKey}</a>
                                            </li>
                                        </ol>
                                        <h1 id="summary-val">{this.props.ticket.summary} </h1>
                                    </div>
                                </div>
                                <button type="button" className="btn" data-toggle="modal"
                                        style={style1}
                                        data-target="#editTicketModal">Edit
                                </button>
                            </div>
                        </div>
                    </header>
                )
            }
        }

        class TicketDatesComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    showDates: true,
                }
            }

            switchDatesViewMode = () => {
                this.setState({
                    showDates: !this.state.showDates
                })
            }

             renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                return (
                    <div className="mod-content">
                        <div className="item-details">
                            <dl className="dates">
                                <dt>
                                    Created:
                                </dt>
                                <dd className="date user-tz" title={this.props.ticket.createdDate}>
                                            <span data-name="Created" id="created-val" data-fieldtype="datetime">
                                                <time className="livestamp" dateTime={this.props.ticket.createdDate}>
                                                    {this.props.ticket.createdDate}
                                                </time>
                                            </span>
                                </dd>
                            </dl>
                            <dl className="dates">
                                <dt>
                                    Updated:
                                </dt>
                                <dd className="date user-tz" title={this.props.ticket.modifiedDate}>
                                            <span data-name="Updated" id="updated-val" data-fieldtype="datetime">
                                                <time className="livestamp" dateTime={this.props.ticket.modifiedDate}>
                                                    {this.props.ticket.modifiedDate}
                                                </time>
                                            </span>
                                </dd>
                            </dl>
                        </div>
                    </div>
                )
            }


            render() {
                return (
                    <div id="datesmodule" className="module toggle-wrap">
                        <div id="datesmodule_heading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="Dates" aria-controls="datesmodule"
                                    aria-expanded="true" onClick={this.switchDatesViewMode}>
                                <span className="accicon"><i className="fas fa-angle-down rotate-icon"></i></span>
                            </button>
                            <h4 className="toggle-title" id="datesmodule-label">Dates</h4>
                            <ul className="ops"></ul>
                        </div>
                        {this.state.showDates ? this.renderNormalMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class TicketDetailsComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    showDetails: true,
                }
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                const style1 = {
                    backgroundColor: this.props.ticket.status.colour,
                    color: 'white',
                }
                const style2 = {
                    backgroundColor: ' #DFE1E5',
                }
                const style3 = {
                    height: "auto"
                }
                return (
                    <div className="mod-content">
                        <ul id="issuedetails" className="property-list two-cols">
                            <li className="item">
                                <div className="wrap">
                                    <strong className="name" title="Type">
                                        <label htmlFor="issuetype">Type:</label>
                                    </strong>
                                    <span id="type-val" className="value">
                                        <img alt={this.props.ticket.issueType.internalKey} height="16"
                                             src={this.props.ticket.issueType.icon}
                                             title={this.props.ticket.issueType.internalKey}
                                             width="16"></img>
                                        &nbsp;&nbsp;
                                        {this.props.ticket.issueType.internalKey}
                                    </span>
                                </div>
                            </li>
                            <li className="item item-right">
                                <div className="wrap">
                                    <strong className="name" title="Status">Status:</strong>
                                    <span id="status-val" className="value">
                                        <span
                                            className=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-yellow jira-issue-status-lozenge-indeterminate jira-issue-status-lozenge-max-width-medium"
                                            style={style1}>
                                            {this.props.ticket.status.internalKey}
                                        </span>
                                    </span>
                                </div>
                            </li>
                            <li className="item new">
                                <div className="wrap">
                                    <strong className="name" title="Priority">
                                        <label htmlFor="priority-field">Priority:</label>
                                    </strong>
                                    <span id="priority-val" className="value">
                                        <img alt={this.props.ticket.priority.internalKey} height="16"
                                             src={this.props.ticket.priority.icon}
                                             title={this.props.ticket.priority.internalKey}
                                             width="16"></img>
                                        &nbsp;&nbsp;
                                        {this.props.ticket.priority.internalKey}
                                    </span>
                                </div>
                            </li>
                            <li className="item item-right">
                                <div className="wrap">
                                    <strong className="name" title="Resolution">Resolution:</strong>
                                    <span id="resolution-val"
                                          className={"value " + this.props.ticket.resolution.internalKey}> {this.props.ticket.resolution.internalKey} </span>
                                </div>
                            </li>
                            <li className="item">
                                <div className="wrap">
                                    <strong className="name" title="Component/s">
                                        <label htmlFor="components">Component/s:</label>
                                    </strong>
                                    <span id="components-val" className="value">
                                          <span className="shorten" id="components-field" resolved=""
                                                style={style3}>
                                              {
                                                  this.props.ticket.components.map((component, i) =>
                                                      <a key={i} title="core Jenkins core"
                                                         href={"{% url 'jira:issuesListView' %}?project=" + this.props.ticket.project.code + "&component=" + component.code}>
                                                          {component.internalKey}&nbsp;&nbsp;
                                                      </a>
                                                  )
                                              }
                                          </span>
                                      </span>
                                </div>
                            </li>

                            <li className="item item-right">
                                <div className="wrap">
                                    <strong className="name" title="StoryPoint">Story Point:</strong>
                                    <span id="storyPoint-val" className={"value " + this.props.ticket.storyPoints}>
                                        {this.props.ticket.storyPoints}
                                    </span>
                                </div>
                            </li>

                            <li className="item">
                                <div className="wrap" id="wrap-labels">
                                    <strong className="name" title="Labels"> <label
                                        htmlFor="labels-textarea">Labels:</label> </strong>
                                    {
                                        // TODO: ticket filtering based on label is not Implemented.
                                        this.props.ticket.labels.map((label, i) =>
                                            <div className="labels-wrap value" key={i}>
                                                <a href={"{% url 'jira:issuesListView' %}?project=" + this.props.ticket.project.code + "&label=" + label.code}
                                                   className="aui-lozenge"
                                                   style={style2}
                                                   title={label.internalKey}>
                                                    {label.internalKey}
                                                </a>
                                            </div>
                                        )
                                    }
                                </div>
                            </li>

                            <li className="item item-right">
                                <div className="wrap">
                                    <strong className="name" title="fixVersion">Fix version:</strong>
                                    <span id="fixVersion-val" className={"value " + this.props.ticket.fixVersion}>
                                        {this.props.ticket.fixVersion}
                                    </span>
                                </div>
                            </li>
                        </ul>
                    </div>
                )
            }

            switchDetailViewMode = () => {
                this.setState({
                    showDetails: !this.state.showDetails
                })
            }

            render() {
                return (
                    <div id="details-module" className="module toggle-wrap">
                        <div id="details-module_heading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="Details"
                                    aria-controls="details-module" aria-expanded="true" onClick={this.switchDetailViewMode}>
                                <span className="accicon"><i className="fas fa-angle-down rotate-icon"></i></span>
                            </button>
                            <h4 className="toggle-title" id="details-module-label">Details</h4>
                            <ul className="ops"></ul>
                        </div>
                        {this.state.showDetails ? this.renderNormalMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class TicketPeopleComponent extends React.Component {
            constructor(props) {
                super(props);

                const icon = 'https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png';

                let unassignedProfile = {
                    id: 0,
                    fullName: "Unassigned",
                    icon: icon
                }

                let assignee = this.props.assignee === null ? unassignedProfile : this.props.assignee;
                let reporter = this.props.reporter === null ? unassignedProfile : this.props.reporter;
                let watchers = this.props.watchers;
                watchers.isWatching = eval(watchers.isWatching);

                this.state = {
                    assignee: assignee,
                    reporter: reporter,
                    watchers: watchers,
                    showPeople: true,
                }
            }

            switchPeopleViewMode = () => {
                this.setState({
                    showPeople: !this.state.showPeople
                })
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                return (
                    <div className="mod-content">
                        <div className="item-details people-details" id="peopledetails">
                            <dl>
                                <dt title="Assignee">
                                    <label htmlFor="assignee-field">Assignee:</label>
                                </dt>
                                <dd>
                                        <span id="assignee-val" className="view-issue-field">
                                            <span className="aui-avatar aui-avatar-small">
                                                <span className="aui-avatar-inner">
                                                    <img
                                                        src={this.state.assignee.icon}
                                                        alt={this.state.assignee.fullName}></img>
                                                </span>
                                            </span>&nbsp;&nbsp;
                                            {this.state.assignee.fullName}
                                        </span>
                                </dd>
                            </dl>
                            <dl>
                                <dt title="Reporter">
                                    <label htmlFor="reporter-field">Reporter:</label>
                                </dt>
                                <dd>
                                        <span id="reporter-val" className="view-issue-field">
                                            <span className="user-hover" id="issue_summary_reporter_dumam"
                                                  rel={this.state.reporter.fullName}>
                                                <span className="aui-avatar aui-avatar-small">
                                                    <span className="aui-avatar-inner">
                                                        <img src={this.state.reporter.icon}
                                                             alt={this.state.reporter.fullName}></img>
                                                    </span>
                                                </span>
                                                &nbsp;&nbsp;
                                                {this.state.reporter.fullName}
                                            </span>
                                        </span>
                                </dd>
                            </dl>
                        </div>
                        <div className="item-details">
                            <dl>
                                <dt title="Votes">Votes:</dt>
                                <dd>
                                    <aui-badge id="vote-data" className="">0</aui-badge>
                                    <span id="vote-label"
                                          title="You have to be logged in to vote for an issue.">&nbsp;&nbsp;Vote for this issue</span>
                                </dd>
                            </dl>
                            <dl>
                                <dt title="Watchers">Watchers:</dt>
                                <dd>
                                    {this.state.watchers.isWatching ? <span
                                            className="badge badge-pill badge-primary">{this.state.watchers.counter}</span> :
                                        <aui-badge id="watcher-data"
                                                   className="">{this.state.watchers.counter}</aui-badge>}
                                    &nbsp;
                                    <span id="watch-label"
                                          title={this.state.watchers.message}>{!this.state.watchers.isWatching ? " Watch this issue" : " Unwatch this issue"}</span>
                                </dd>
                            </dl>
                        </div>
                    </div>
                )
            }

            render() {
                return (
                    <div id="peoplemodule" className="module toggle-wrap">
                        <div id="peoplemodule_heading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="People" aria-controls="peoplemodule"
                                    aria-expanded="true" onClick={this.switchPeopleViewMode}>
                                <span className="accicon">
                                    <i className="fas fa-angle-down rotate-icon"></i>
                                </span>
                            </button>
                            <h4 className="toggle-title" id="peoplemodule-label">People</h4>
                            <ul className="ops"></ul>
                        </div>
                        {this.state.showPeople ? this.renderNormalMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class TicketDescriptionComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    showDescription: true,
                }
            }

            switchDescriptionViewMode = () => {
                this.setState({
                    showDescription: !this.state.showDescription
                })
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                const style1 = {
                    whiteSpace: "pre-line"
                }

                return (
                    <div className="mod-content">
                        <div id="description-val" className="field-ignore-highlight">
                            <div className="user-content-block" style={style1}>
                                {this.props.ticket.description}
                            </div>
                        </div>
                    </div>
                )
            }

            render() {
                return (
                    <div id="descriptionModule" className="module toggle-wrap">
                        <div id="descriptionModule_heading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="Description"
                                    aria-controls="descriptionModule" aria-expanded="true"
                                    onClick={this.switchDescriptionViewMode}>
                                <span className="accicon"><i className="fas fa-angle-down rotate-icon"></i></span>
                            </button>
                            <h4 className="toggle-title" id="descriptionmodule-label">Description</h4>
                            <ul className="ops"></ul>
                        </div>
                        {this.state.showDescription ? this.renderNormalMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class Thumbnail extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {
                return (
                    <li className="attachment-content js-file-attachment" draggable="true"
                        data-downloadurl="image/png:image-2022-06-21-21-22-35-447.png:https://issues.jenkins.io/secure/attachment/58242/image-2022-06-21-21-22-35-447.png"
                        data-issue-id={this.props.attachment.id} data-attachment-type="image"
                        data-attachment-thumbnail="true">
                        <div className="attachment-thumb">
                            <a href={this.props.attachment.url}
                               title={this.props.attachment.name}
                               file-preview-id={this.props.attachment.id}
                               file-preview-title={this.props.attachment.name}
                               file-preview-type="image"
                               file-preview-url="https://issues.jenkins.io/secure/thumbnail/58242/_thumb_58242.png"
                               resolved="">
                                <img loading="lazy"
                                     src={this.props.attachment.icon}
                                     alt={this.props.attachment.name}></img>
                            </a>
                        </div>
                        <dl>
                            <dt>
                                <span className="blender"></span>
                                <a
                                    href={this.props.attachment.url}
                                    className="attachment-title"
                                    title={this.props.attachment.name}
                                    file-preview-id={this.props.attachment.id}
                                    file-preview-title={this.props.attachment.name}
                                    file-preview-type="image"
                                    file-preview-url="https://issues.jenkins.io/secure/thumbnail/58242/_thumb_58242.png"
                                    resolved="">{this.props.attachment.internalKey}</a></dt>
                            <dd className="attachment-size">{this.props.attachment.size}</dd>
                            <dd className="attachment-date">
                                <time className="livestamp"
                                      dateTime={this.props.attachment.createdDttm}>{this.props.attachment.createdDttm}
                                </time>
                            </dd>
                        </dl>
                    </li>
                )
            }
        }

        class TicketAttachmentComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    showAttachments: true,
                    attachments: []
                }

            }

            renderEmptyMode = () => {
                return <div></div>
            }

            switchAttachmentsViewMode = () => {
                this.setState({
                    showAttachments: !this.state.showAttachments
                })
            }

            componentDidMount = () => {
                this.fetchTicketAttachments();
            }

            renderNormalMode = () => {
                return (
                    <div className="mod-content">
                        <ol id="attachment_thumbnails" className="item-attachments" data-sort-key="fileName"
                            data-sort-order="asc">
                            {this.state.attachments.map((item => <Thumbnail key={item.id} attachment={item}/>))}
                        </ol>
                    </div>
                )
            }


            fetchTicketAttachments()
            {
                fetch('{% url 'jira:ticketAttachmentsApiEventVersion1Component' ticketId=ticket.id %}')
                    .then(response => response.json())
                    .then(data => this.setState({
                        attachments: data.data.attachments
                    }))

            }

            render() {
                return (
                    <div id="attachmentModule" className="module toggle-wrap">
                        <div id="attachmentModuleHeading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="Attachments"
                                    aria-controls="attachmentModule" aria-expanded="true" onClick={this.switchAttachmentsViewMode}>
                                <span className="accicon"><i className="fas fa-angle-down rotate-icon"></i></span>
                            </button>
                            <h4 className="toggle-title" id="attachmentmodule-label">Attachments</h4>
                            <ul className="ops">
                                <li className="drop">
                                    <div className="aui-dd-parent">
                                        <button
                                            className="aui-button aui-button-compact aui-button-subtle js-default-dropdown"
                                            title="Options" aria-label="Attachments panel options" resolved=""
                                            id="AJS_DROPDOWN__4" aria-controls="AJS_DROPDOWN__4_drop"
                                            aria-haspopup="true" aria-expanded="false"><span
                                            className="aui-icon aui-icon-small aui-iconfont-more">Options</span>
                                        </button>
                                        <div className="aui-dropdown-content aui-list">
                                            <ul id="attachment-sorting-options" className="aui-list-section aui-first">
                                                <li className="aui-list-item"><a id="attachment-sort-key-name"
                                                                                 href="/browse/JENKINS-68799?attachmentSortBy=fileName#attachmentModule"
                                                                                 className="aui-list-checked aui-checked aui-list-item-link"
                                                                                 title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a>
                                                </li>
                                                <li className="aui-list-item"><a id="attachment-sort-key-date"
                                                                                 href="/browse/JENKINS-68799?attachmentSortBy=dateTime#attachmentModule"
                                                                                 className="aui-list-checked aui-list-item-link"
                                                                                 title="Sort By Date"><span>Sort By Date</span></a>
                                                </li>
                                            </ul>
                                            <ul id="attachment-sorting-order-options" className="aui-list-section">
                                                <li className="aui-list-item"><a id="attachment-sort-direction-asc"
                                                                                 href="/browse/JENKINS-68799?attachmentOrder=asc#attachmentModule"
                                                                                 className="aui-list-checked aui-checked aui-list-item-link"
                                                                                 title="Ascending"><span>Ascending</span></a>
                                                </li>
                                                <li className="aui-list-item"><a id="attachment-sort-direction-desc"
                                                                                 href="/browse/JENKINS-68799?attachmentOrder=desc#attachmentModule"
                                                                                 className="aui-list-checked aui-list-item-link"
                                                                                 title="Descending"><span>Descending</span></a>
                                                </li>
                                            </ul>
                                            <ul id="attachment-view-mode-options" className="aui-list-section">
                                                <li className="aui-list-item"><a id="attachment-view-mode-gallery"
                                                                                 href="/browse/JENKINS-68799?attachmentViewMode=gallery#attachmentModule"
                                                                                 className="aui-list-checked aui-checked aui-list-item-link"
                                                                                 title="Thumbnails"><span>Thumbnails</span></a>
                                                </li>
                                                <li className="aui-list-item"><a id="attachment-view-mode-list"
                                                                                 href="/browse/JENKINS-68799?attachmentViewMode=list#attachmentModule"
                                                                                 className="aui-list-checked aui-list-item-link"
                                                                                 title="List"><span>List</span></a></li>
                                            </ul>
                                            <ul id="attachment-manage-options" className="aui-list-section aui-last">
                                                <li className="aui-list-item"><a id="aszip"
                                                                                 href="/secure/attachmentzip/215653.zip"
                                                                                 className="aui-list-checked aui-list-item-link"
                                                                                 title="Download all attachments as a ZIP file"><span>Download All</span></a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            {this.state.showAttachments ? this.renderNormalMode() : this.renderEmptyMode()}
                        </div>
                    </div>
                )
            }
        }

        class TicketBar extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    assigneeIcon: this.props.ticket.assignee.icon ? this.props.ticket.assignee.icon : "https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png",
                    assigneeName: this.props.ticket.assignee.fullName ? this.props.ticket.assignee.fullName : "Unassigned"
                }
            }

            render() {
                const style1 = {
                    height: "10px"
                }
                const style2 = {
                    marginTop: "-13px",
                    marginLeft: "-10px"
                }

                const style3 = {
                    marginTop: "-12px",
                    marginLeft: "-15px"
                }

                return (
                    <div className="card grabbable" id={this.props.ticket.id}>
                        <div className="card-body" style={style1}>
                            <div className="row">
                                <div className="col-auto" style={style2}>
                                    <img src={this.props.ticket.issueType.icon} width="20" height="20"
                                         data-toggle="tooltip"
                                         data-placement="top" title={this.props.ticket.issueType.internalKey}></img>
                                </div>
                                <div className="col-auto" style={style3}>
                                    <a href={this.props.ticket.url}>{this.props.ticket.internalKey}</a>
                                </div>
                                <div className="col" style={style3}>
                                    <span>{this.props.ticket.summary}</span>
                                </div>
                                <div className="col-auto" style={style2}>
                                    <img src={this.props.ticket.priority.icon} width="20" height="20"
                                         data-toggle="tooltip"
                                         data-placement="top" title={this.props.ticket.priority.internalKey}></img>
                                </div>
                                <div className="col-auto" style={style2}>
                                    <img src={this.state.assigneeIcon} width="25" height="25"
                                         data-toggle="tooltip" data-placement="top"
                                         title={this.state.assigneeName}></img>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
        }

        class LinkingModuleHead extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    heading: this.props.isEpic ? "Issues in the epic" : "Subtasks"
                }
            }

            render() {

                const style1 = {
                    fontSize: "24px",
                    cursor: "pointer"
                }
                return (
                    <div id="linkingmodule_heading" className="mod-header">
                        <button className="aui-button toggle-title" aria-label="Issue Links"
                                aria-controls="linkingmodule" aria-expanded="true" resolved="">
                            <span className="accicon">
                                <i className="fas fa-angle-down rotate-icon"></i>
                            </span>
                        </button>
                        <div className="row">
                            <div className="col">
                                <p className="font-weight-bold">{this.state.heading}</p>
                            </div>
                            <div className="col-auto">
                                <i className="fa fa-plus-square float-right"
                                   style={style1} onClick={this.props.switchCreateMode}
                                ></i>
                            </div>
                        </div>
                    </div>
                );
            }
        }

        class LinkingModuleBody extends React.Component {
            constructor(props) {
                super(props);
                let issueTypeList = localStorage.getItem("issueTypeList");

                if (issueTypeList != null) {
                    issueTypeList = JSON.parse(issueTypeList).object;
                    const STORY = "STORY";
                    issueTypeList.sort(function (x, y) {
                        return x.code == STORY ? -1 : y.code == STORY ? 1 : 0;
                    });
                }
                else{
                    issueTypeList = [];
                }

                this.state = {
                    issueType: null,
                    summary: null,
                    issueTypes: issueTypeList,
                }
            }

            renderNormalMode = () => {
                return <div></div>
            }

            createNewTicket = () => {
                fetch('{% url 'jira:ticketObjectForEpicTicketApiEventVersion1Component' %}', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json',
                    },
                    body: JSON.stringify({
                        'ticketId': this.props.ticket.id,
                        'ticketSummary': this.refs.summaryInput.value,
                        'issueType': this.refs.issueTypeInput.value,
                    })
                }).then((response) => {
                    this.props.fetchEpicTasks()
                    this.props.switchCreateMode()
                })
            }

            createSubTask = () => {
                fetch('{% url 'jira:subTaskTicketObjectForTicketApiEventVersion1Component' %}', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json',
                    },
                    body: JSON.stringify({
                        'ticketId': this.props.ticket.id,
                        'ticketSummary': this.refs.summaryInput.value,
                    })
                }).then((response) => {
                    this.props.fetchSubTasks()
                    this.props.switchCreateMode()
                })
            }

            renderNewTicketMode = () => {
                const style1 = {
                    marginRight: "25px"
                }
                if (this.props.isEpic) {
                    return (
                        <div id="new-ticket-creator">
                            <div className="row">
                                <div className="col-4">
                                    <select id="issueType" data-show-content="true" className="form-control"
                                            ref="issueTypeInput">
                                        {this.state.issueTypes.map((type) => <option key={type.id}
                                                                                     defaultValue={type.code}> {type.internalKey}</option>)}
{#                                       {% for ji in ticketIssueTypes %}#}
{#                                            {% if ji.code == "STORY" %}#}
{#                                                <option#}
{#                                                    data-content="<img src='{% static ji.icon %}' width='20' height='20'>&nbsp; {{ ji }}"#}
{#                                                    defaultValue="{{ ji.code }}"#}
{#                                                    selected="selected">{{ ji.internalKey }}</option>#}
{#                                            {% else %}#}
{#                                                <option#}
{#                                                    data-content="<img src='{% static ji.icon %}' width='20' height='20'>&nbsp; {{ ji }}"#}
{#                                                    defaultValue="{{ ji.code }}">{{ ji.internalKey }}</option>#}
{#                                            {% endif %}#}
{#                                        {% endfor %}#}
                                    </select>
                                </div>
                                <div className="col-8">
                                    <input className="form-control pull-right" id="new-ticket-name" type="text"
                                           ref="summaryInput"
                                           placeholder="What needs to be done?"></input>
                                </div>
                            </div>
                            <br></br>
                            <div>
                                <button type="button" className="btn btn-primary pull-right"
                                        onClick={this.createNewTicket}>Create
                                </button>
                                <button type="button" className="btn btn-light pull-right" style={style1}
                                        onClick={this.props.switchCreateMode}>Cancel
                                </button>
                            </div>
                        </div>
                    )
                } else {
                    return (
                        <div id="subtask-tickets-container">
                            <div id="subtask-tickets-creator">
                                <input className="form-control" id="new-sub-task-name" type="text" ref="summaryInput"
                                       placeholder="What needs to be done in this sub task?"></input>
                                <br></br>
                                <button type="button" className="btn btn-primary pull-right"
                                        onClick={this.createSubTask}>Create
                                </button>
                                <button type="button" className="btn btn-light pull-right" style={style1}
                                        onClick={this.props.switchCreateMode}>Cancel
                                </button>
                            </div>
                        </div>
                    )
                }
            }

            render() {
                return (
                    <div id="tickets-list-container">
                        {this.props.isEpic ? this.props.epicTickets.map((ticket) => <TicketBar key={ticket.id}
                                                                                               ticket={ticket}/>) : this.props.subTaskTickets.map((ticket) =>
                            <TicketBar key={ticket.id} ticket={ticket}/>)}
                        {this.props.inCreateMode ? this.renderNewTicketMode() : this.renderNormalMode()}
                    </div>
                )
            }
        }

        class LinkingModuleComponent extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    isEpic: this.props.ticket.issueType.internalKey === 'Epic',
                    inCreateMode: false,
                    epicTickets: [],
                    subTaskTickets: []
                }

                this.switchCreateMode = this.switchCreateMode.bind(this)
                this.fetchEpicTasks = this.fetchEpicTasks.bind(this)
                this.fetchSubTasks = this.fetchSubTasks.bind(this)
            }

            componentDidMount = () => {
                if (this.state.isEpic)
                    this.fetchEpicTasks()
                else
                    this.fetchSubTasks()
            }

            fetchEpicTasks() {
                fetch('{% url 'jira:ticketsForEpicTicketApiEventVersion1Component' ticketId=ticket.id %}')
                    .then(response => response.json())
                    .then(data => this.setState({
                        epicTickets: data.data.tickets
                    }))
            }

            fetchSubTasks() {
                fetch('{% url 'jira:subTaskTicketsForTicketApiEventVersion1Component' ticketId=ticket.id %}')
                    .then(response => response.json())
                    .then(data => this.setState({
                        subTaskTickets: data.data.tickets
                    }))
            }

            switchCreateMode = () => {
                this.setState({
                    inCreateMode: !this.state.inCreateMode
                })
            }

            render() {
                return (
                    <div id="linkingmodule" className="module toggle-wrap">
                        <LinkingModuleHead isEpic={this.state.isEpic} inCreateMode={this.state.inCreateMode}
                                           switchCreateMode={this.switchCreateMode}/>
                        <br></br>
                        <LinkingModuleBody isEpic={this.state.isEpic} inCreateMode={this.state.inCreateMode}
                                           switchCreateMode={this.switchCreateMode} epicTickets={this.state.epicTickets}
                                           fetchEpicTasks={this.fetchEpicTasks} fetchSubTasks={this.fetchSubTasks}
                                           subTaskTickets={this.state.subTaskTickets} ticket={this.props.ticket}/>
                    </div>
                );
            }
        }

        class TicketCommentInstanceComponent extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {
                return (
                    <div id={"comment-" + this.props.comment.id}
                         className="issue-data-block activity-comment twixi-block expanded">
                        <div className="twixi-wrap verbose actionContainer">
                            <div className="action-head">
                                <button aria-label="Collapse comment" title="Collapse comment"
                                        className="twixi icon-default aui-icon aui-icon-small aui-iconfont-expanded"></button>
                                <div className="action-details">
                                    <a className="user-hover user-avatar" rel="7ad1551c39c0"
                                       id="commentauthor_2600002_verbose"
                                       href="/secure/ViewProfile.jspa?name=7ad1551c39c0"><span
                                        className="aui-avatar aui-avatar-xsmall"><span className="aui-avatar-inner"><img
                                        src={this.props.comment.creator.icon}
                                        alt="https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png"></img></span></span> {this.props.comment.creator.fullName}
                                    </a>
                                    &nbsp;added a comment at <a
                                    href="/browse/JSDCLOUD-9247?focusedCommentId=2600002&amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-2600002"
                                    className="commentdate_2600002_verbose subText comment-created-date-link"><span
                                    className="date user-tz" title={this.props.comment.createdDttm}>
                                    <time className="livestamp"
                                          dateTime={this.props.comment.createdDttm}>{this.props.comment.createdDttm}</time></span></a>
                                    &nbsp;&nbsp;{this.props.comment.edited ?
                                    <span className="text-secondary">(edited)</span> : <span></span>}
                                </div>
                            </div>
                            <div className="action-body flooded"><span>
                                {this.props.comment.comment.split('\n').map(str => <p key={"comment-" + this.props.comment.id}>{str}</p>)}
                            </span></div>
                            <div className="action-links action-comment-actions">
                            </div>
                        </div>
                    </div>
                )
            }
        }

        class ActivityModuleBody extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    inCreateMode: false,
                }
            }

            switchCreateMode = () => {
                this.setState({
                    inCreateMode: !this.state.inCreateMode
                })
            }

            renderNormalMode = () => {
                const style1 = {
                    backgroundColor: '#f5f6f8'
                }
                return <button type="button" className="btn" style={style1} onClick={this.switchCreateMode}>Add
                    comment</button>
            }

            createNewComment = () => {
                if (this.refs.comment.value && !this.refs.comment.value.trim() || this.refs.comment.value.length === 0)
                    return;

                fetch('{% url 'jira:ticketCommentObjectApiEventVersion1Component' %}', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json',
                    },
                    body: JSON.stringify({
                        'ticketId': this.props.ticket.id,
                        'comment': this.refs.comment.value,
                    })
                }).then((response) => {
                    switch (response.status) {
                        case 200:
                            this.props.fetchComments();
                            break;
                        case 401:
                            Swal.fire(
                                {
                                    icon: 'error',
                                    title: "Can't do that!",
                                    text: 'Please login to add a comment'
                                }
                            );
                            break;
                        default:
                            Swal.fire(
                                {
                                    icon: 'error',
                                    title: "Can't do that!",
                                    text: 'Unable to perform this action'
                                }
                            );
                    }

                })

                this.switchCreateMode();
            }

            renderNewCommentMode = () => {
                return (
                    <div className="className-group">
                        <textarea className="form-control" id="commentBox" placeholder="Write comment here..."
                                  rows="4" ref="comment"></textarea>
                        <br></br>
                        <button type="button" className="btn btn-outline-primary float-right" onClick={this.createNewComment}>Submit</button>
                        <span></span>
                        <button type="button" className="btn btn-outline-danger float-right" onClick={this.switchCreateMode}>Cancel</button>
                    </div>
                );
            }

            render() {

                return (
                    <div id="ticket-comment-list-container">
                        {this.props.comments.map((comment) => <TicketCommentInstanceComponent key={comment.id}
                                                                                              comment={comment}/>)}
                        <br></br>
                        <br></br>
                        {this.state.inCreateMode ? this.renderNewCommentMode() : this.renderNormalMode()}
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                    </div>
                )
            }

        }


        class TicketActivityModuleComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    comments: []
                }
                this.fetchComments = this.fetchComments.bind(this)
            }

            componentDidMount = () => {
                this.fetchComments();
            }

            fetchComments() {
                fetch('{% url 'jira:ticketCommentsApiEventVersion1Component' ticketId=ticket.id %}')
                    .then(response => response.json())
                    .then(data => this.setState({
                        comments: data.data.comments
                    }))
            }

            render() {
                return (
                    <div id="activitymodule" className="module toggle-wrap">
                        <div id="activitymodule_heading" className="mod-header">
                        <button className="aui-button toggle-title" aria-label="Activity"
                                aria-controls="activitymodule" aria-expanded="true" resolved="">
                            <span className="accicon"><i className="fas fa-angle-down rotate-icon"></i></span>
                        </button>
                        <div className="row">
                            <div className="col">
                                <p className="font-weight-bold">Comments</p>
                            </div>
                        </div>
                    </div>
                        <br></br>
                        <ActivityModuleBody
                            comments={this.state.comments}
                            fetchComments={this.fetchComments}
                            ticket={this.props.ticket}/>
                    </div>
                )
            }
        }

        class TicketViewComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    ticket: null
                }
            }

            componentDidMount = () => {
                fetch('{% url 'jira:ticketObjectDetailApiEventVersion1Component' ticketId=ticket.id%}', {
                    method: 'GET',
                }).then((response) => response.json())
                    .then((json) => {
                        this.setState({
                            ticket: json.data
                        })
                    })
            }

            renderNormalMode = () => {
                return (
                    <div>
                        <TicketHeaderComponent ticket={this.state.ticket}/>
                        <div className="issue-body-content">
                            <div className="aui-group issue-body">

                                <div className="aui-item issue-main-column">
                                    <TicketDetailsComponent ticket={this.state.ticket}/>
                                    <TicketDescriptionComponent ticket={this.state.ticket}/>
                                    <TicketAttachmentComponent ticket={this.state.ticket}/>
                                    <LinkingModuleComponent ticket={this.state.ticket}/>
                                    <TicketActivityModuleComponent ticket={this.state.ticket}/>
                                </div>

                                <div id="view-issue-sidebar" className="aui-item issue-side-column">
                                    <TicketPeopleComponent assignee={this.state.ticket.assignee}
                                                           reporter={this.state.ticket.reporter}
                                                           watchers={this.state.ticket.watchers}/>
                                    <TicketDatesComponent ticket={this.state.ticket}/>
                                </div>

                            </div>
                        </div>
                    </div>
                )
            }

            renderEmptyMode = () => {
                return <div></div>
            }


            render() {
                return (
                    <div>
                        {this.state.ticket === null ? this.renderEmptyMode() : this.renderNormalMode()}
                    </div>
                )
            }
        }

        ReactDOM.render(<TicketViewComponent/>, document.getElementById('issue-content'));
    </script>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
{% endblock %}