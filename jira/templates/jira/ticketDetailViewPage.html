{% extends "accounts/base.html" %}
{% load static %}
{% block content %}

    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css"/>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>


    <link type="text/css" rel="stylesheet" href="{% static 'css/ticketPageCss1.css' %}" media="all">
    <link type="text/css" rel="stylesheet" href="{% static 'css/ticketPageCss2.css' %}" media="all">

    <style>
        .file-drop-area {
            position: relative;
            display: flex;
            align-items: center;
            width: 450px;
            max-width: 100%;
            padding: 25px;
            border: 1px dashed rgba(255, 255, 255, 0.4);
            border-radius: 3px;
            transition: 0.2s;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            cursor: pointer;
            opacity: 0;
        }
    </style>

    <div class="modal fade bd-example-modal-lg" id="editTicketModal" tabindex="-1" role="dialog"
         aria-labelledby="myLargeModalLabel" aria-hidden="true" style="color: black;">
        <div class="modal-dialog" role="document" style="max-width: 1000px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Edit Issue: {{ ticket.internalKey }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="project-add-details" role="tabpanel">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" type="reset" data-dismiss="modal" style="background-color: #f5f6f8;">Cancel</button>
                        <input class="btn" type="submit" style="background-color: #0052cc; color: white" value="Update">
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="issue-content" class="issue-edit-form">
    </div>

    <script type="text/javascript">
        function getIssueTypeOptions() {
            // TODO: Get this from cache or API.
            let items = [];

            {% for item in ticketIssueTypes %}
                items.push({
                    id: '{{ item.id }}',
                    icon: "{{ item.icon }}",
                    internalKey: "{{ item.internalKey }}",
                    code: "{{ item.code }}",
                    isCurrent: "{{ item.code }}" === "{{ ticket.issueType.code }}",
                })
            {% endfor %}
            return items;
        }

        function getPriorityOptions() {
            // TODO: Get this from cache or API.
            let items = [];

            {% for item in ticketPriorities %}
                items.push({
                    id: '{{ item.id }}',
                    icon: "{{ item.icon }}",
                    internalKey: "{{ item.internalKey }}",
                    code: "{{ item.code }}",
                    isCurrent: "{{ item.code }}" === "{{ ticket.issueType.code }}",
                })
            {% endfor %}
            return items;
        }

        function getComponentOptions() {
            // TODO: Get this from cache or API.
            let items = [];

            {% for item in projectComponents %}
                items.push({
                    id: '{{ item.id }}',
                    internalKey: "{{ item.internalKey }}",
                })
            {% endfor %}
            return items;
        }

        function getLabelsOptions() {
            let items = [];

            fetch("{% url 'jira:labelObjectApiEventVersion1Component' %}", {
                method: 'GET',
            }).then((response) => response.json())
                .then((response) => {
                    if (response.success) {
                        for (const label of response.data.labels) {
                            items.push({
                                id: label.internalKey,
                                internalKey: label.internalKey,
                            })
                        }
                    }
                })

            return items;
        }

        function getComponentDefaultValues() {

            let items = [];
            {% for component in ticket.components %}
                items.push('{{ component.id }}')
            {% endfor %}
            return items;
        }

        function getLabelsDefaultValues() {

            let items = [];
            {% for label in ticket.labels %}
                items.push('{{ label.internalKey }}')
            {% endfor %}
            return items;
        }

        function getUsersOptions() {
            // TODO: Get this from cache or API.
            let items = [];

            {% for item in profiles %}
                items.push({
                    id: "{{ item.user.id }}",
                    icon: "{{ item.profilePicture.url }}",
                    internalKey: "{{ item.user.get_full_name }}",
                    code: "{{ item.id }}",
                    isCurrent: "{{ item.user.id }}" === "{{ ticket.assignee.id }}",
                })
            {% endfor %}
            return items;
        }

        const ticketEditFields = [
            {
                id: "summary",
                internalKey: "Summary",
                defaultValue: "{{ ticket.summary }}",
                isRequired: true,
                elementType: "TEXT",
                options: null,
                isMultiple: false,
                enableSelectPicker: false,
                enabled: true,
            },
            {
                id: "issueType",
                internalKey: "Issue Type",
                defaultValue: "{{ ticket.issueType.id }}",
                isRequired: true,
                elementType: "SELECT",
                options: getIssueTypeOptions(),
                isMultiple: false,
                enableSelectPicker: true,
                enabled: true,
            },
            {
                id: "priority",
                internalKey: "Priority",
                defaultValue: "{{ ticket.priority.id }}",
                isRequired: true,
                elementType: "SELECT",
                options: getPriorityOptions(),
                enableSelectPicker: true,
                isMultiple: false,
                enabled: true,
            },
            {
                id: "components",
                internalKey: "Components",
                defaultValue: getComponentDefaultValues(),
                isRequired: false,
                elementType: "SELECT",
                options: getComponentOptions(),
                enableSelectPicker: false,
                isMultiple: true,
                enabled: true,
            },
            {
                id: "labels",
                internalKey: "Labels",
                defaultValue: getLabelsDefaultValues(),
                isRequired: false,
                elementType: "SELECT",
                options: getLabelsOptions(),
                enableSelectPicker: false,
                isMultiple: true,
                enabled: true,
            },
            {
                id: "storyPoints",
                internalKey: "Story Points",
                defaultValue: "{{ ticket.storyPoints }}",
                isRequired: false,
                elementType: "NUMBER",
                options: null,
                enableSelectPicker: false,
                isMultiple: false,
                enabled: true,
            },
            {
                id: "fixVersion",
                internalKey: "Fix Version",
                defaultValue: "{{ ticket.fixVersion }}",
                isRequired: false,
                elementType: "TEXT",
                options: null,
                enableSelectPicker: false,
                isMultiple: false,
                enabled: true,
            },
            {
                id: "attachments",
                internalKey: "Attachment",
                defaultValue: null,
                isRequired: false,
                elementType: "ATTACHMENT",
                options: null,
                enableSelectPicker: false,
                isMultiple: true,
                enabled: true,
            },
            {
                id: "description",
                internalKey: "Description",
                defaultValue: "{{ ticket.description|linebreaksbr }}",
                isRequired: false,
                elementType: "TEXTAREA",
                options: null,
                enableSelectPicker: false,
                isMultiple: false,
                enabled: true,
            },
            {
                id: "assignee",
                internalKey: "Assignee",
                defaultValue: "{{ ticket.assignee.id }}",
                isRequired: false,
                elementType: "SELECT",
                options: getUsersOptions(),
                enableSelectPicker: true,
                isMultiple: false,
                enabled: true,
            },
        ]

        window.onload = function (e) {
            let editModal = $('#project-add-details');

            for (const field of ticketEditFields) {

                if (!field.enabled)
                    continue;

                let element = null;

                if (field.elementType === "TEXT") {
                    if (field.isRequired)
                        element = `<input class="form-control col" type="text" placeholder="${field.internalKey}" name="${field.id}" value="${field.defaultValue}" required=>`;
                    else
                        element = `<input class="form-control col" type="text" placeholder="${field.internalKey}" name="${field.id}" value="${field.defaultValue}"=>`;
                } else if (field.elementType === "NUMBER") {
                    element = `<input class="form-control col" type="number" placeholder="${field.internalKey}" name="${field.id}" value="${field.defaultValue}">`;
                }
                 else if (field.elementType === "TEXTAREA") {
                    element = `<textarea class="form-control col" rows="5" name="${field.id}" required="${field.isRequired}">${field.defaultValue.replaceAll("<br>", "\n")}</textarea>`;
                } else if (field.elementType === "ATTACHMENT") {
                    element = `
                     <div class="file-drop-area border justify-content-center" style="width: 100%;">
                        <span class="choose-file-button">Choose files</span>
                        <span class="file-message">&nbsp;or drag and drop files here</span>
                        <input class="file-input" name="${field.id}" type="file" multiple="${field.isMultiple}">
                    </div>
                     `;
                }
                else if (field.elementType === "SELECT") {

                    let optionElements = '';
                    if (field.options) {
                        for (const option of field.options) {
                            let iconPlaceHolder = option.icon ? `data-content="<img src='${option.icon}' width='20' height='20'>&nbsp; ${option.internalKey}"` : '';
                            optionElements += `<option value="${option.id}" ${iconPlaceHolder}>${option.internalKey}</option>`;
                        }
                    }

                    if (field.isMultiple)
                        element = `<select style="width: 100%;" id="${field.id}" name="${field.id}" data-show-content="true" class="form-control" data-live-search="true" multiple>${optionElements}</select>`;
                    else
                        element = `<select style="width: 100%;" id="${field.id}" name="${field.id}" data-show-content="true" class="form-control" data-live-search="true">${optionElements}</select>`;

                    if (field.enableSelectPicker) {
                        $('#' + field.id).selectpicker({
                            actionsBox: true,
                            liveSearch: true,
                            liveSearchNormalize: true,
                            width: '100%',
                            title: 'Issue type',
                            showContent: false,
                        });
                    }
                }

                editModal.append(
                    `<dd class="col-sm-12">
                        <label style="font-size: 85%; color: #6c757d;">${field.internalKey}</label><br>
                            ${element}
                    </dd>`
                )

                if (field.elementType === "SELECT") {
                    if (!field.isMultiple)
                        $('#' + field.id).attr('disabled', false)

                    if (field.enableSelectPicker) {
                        $('#' + field.id).selectpicker('refresh');
                        $('#' + field.id).selectpicker('val', field.defaultValue);
                    }
                }
            }

            $('#components').select2().val(getComponentDefaultValues()).trigger("change");

            let ticketLabels = $('#labels').select2({
                tags: true,
            });

            const labels = getLabelsDefaultValues();

            labels.forEach(function (e) {
                if (!ticketLabels.find('option:contains(' + e + ')').length)
                    ticketLabels.append($('<option>').text(e));
            });

            ticketLabels.val(labels).trigger("change");
        }

    </script>

    <script type="text/babel">

        function getCookie(name) {
            let cookieValue = null;

            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');

                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();

                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function stringEquals(a, b) {
            return a.replace(" ", "").toLowerCase().includes(b.replace(" ", "").toLowerCase())
        }

        class TicketHeaderComponent extends React.Component {
            constructor(props) {
                super(props);

                let todo = {
                    id: null,
                    internalKey: "To Do",
                    category: "TODO",
                };
                let inProgress = {
                    id: null,
                    internalKey: "In Progress",
                    category: "IN_PROGRESS",
                };


                for (const item of this.props.ticket.workflow) {
                    if (stringEquals(item.internalKey, todo.internalKey))
                        todo.id = item.id

                    if (stringEquals(item.internalKey, inProgress.internalKey))
                        inProgress.id = item.id
                }

                this.state = {
                    todo: todo,
                    inProgress: inProgress,
                }
            }

            updateColumnStatus = (columnStatusId) => {

                fetch('{% url 'jira:ticketObjectApiEventVersion1Component' ticketId=ticket.id %}', {
                    method: 'PUT',
                    body: JSON.stringify({
                        'columnStatus': columnStatusId,
                    }),
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                }).then((response) => response.json())
                    .then((json) => {

                        if (json.success) {
                            this.props.fetchTicketDetails();
                        }

                    })
            }

            render() {
                const style1 = {
                    backgroundColor: '#f5f6f8'
                }
                return (
                    <header id="stalker" className="issue-header js-stalker">
                        <div className="issue-header-content">
                            <div className="aui-page-header">
                                <div className="aui-page-header-inner">
                                    <div className="aui-page-header-image">
                                <span id="10172" className="aui-avatar aui-avatar-large aui-avatar-project">
                                    <span className="aui-avatar-inner">
                                        <img id="project-avatar"
                                             alt={"Uploaded image for project: " + this.props.ticket.project.internalKey}
                                             src={this.props.ticket.project.icon}></img>
                                    </span>
                                </span>
                                    </div>
                                    <div className="aui-page-header-main">
                                        <ol className="aui-nav aui-nav-breadcrumbs" resolved="">
                                            <li>
                                                <a id="project-name-val"
                                                   href={this.props.ticket.project.link}
                                                   className="">{this.props.ticket.project.internalKey}</a>
                                            </li>
                                            &nbsp;
                                            <li>
                                                <a className="issue-link" data-issue-key={this.props.ticket.link}
                                                   href={this.props.ticket.link} id="key-val"
                                                   rel="215653">{this.props.ticket.internalKey}</a>
                                            </li>
                                        </ol>
                                        <h1 id="summary-val">{this.props.ticket.summary} </h1>
                                    </div>
                                </div>
                                <button type="button" className="btn" data-toggle="modal"
                                        style={style1} data-target="#editTicketModal">Edit
                                </button>
                                &nbsp;&nbsp;
                                <button type="button" className="btn"
                                        style={style1}>Add Comment
                                </button>

                                &nbsp;&nbsp;&nbsp;&nbsp;
                                <button type="button" className="btn"
                                        style={style1}
                                        onClick={() => this.updateColumnStatus(this.state.todo.id)}>To Do
                                </button>
                                &nbsp;&nbsp;
                                <button type="button" className="btn"
                                        style={style1}
                                        onClick={() => this.updateColumnStatus(this.state.inProgress.id)}>In Progress
                                </button>
                                &nbsp;&nbsp;
                                <div className="btn-group">
                                    <button type="button" className="btn dropdown-toggle" data-toggle="dropdown"
                                            aria-haspopup="true" aria-expanded="false" style={style1}>
                                        Workflow
                                    </button>
                                    <div className="dropdown-menu">
                                        {this.props.ticket.workflow.map((wf) => <a className="dropdown-item"
                                                                                   onClick={() => {
                                                                                       this.updateColumnStatus(wf.id)
                                                                                   }}
                                                                                   key={wf.id}>
                                            {wf.internalKey.split(' ').map(w => w[0].toUpperCase() + w.substring(1).toLowerCase()).join(' ')}</a>)
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>
                )
            }
        }

        class TicketDatesComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    showDates: true,
                }
            }

            switchDatesViewMode = () => {
                this.setState({
                    showDates: !this.state.showDates
                })
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                return (
                    <div className="mod-content">
                        <div className="item-details">
                            <dl className="dates">
                                <dt>
                                    Created:
                                </dt>
                                <dd className="date user-tz" title={this.props.ticket.createdDate}>
                                    <span data-name="Created" id="created-val" data-fieldtype="datetime">
                                        <time className="livestamp" dateTime={this.props.ticket.createdDate}>
                                            {this.props.ticket.createdDate}
                                        </time>
                                    </span>
                                </dd>
                            </dl>
                            <dl className="dates">
                                <dt>
                                    Updated:
                                </dt>
                                <dd className="date user-tz" title={this.props.ticket.modifiedDate}>
                                    <span data-name="Updated" id="updated-val" data-fieldtype="datetime">
                                        <time className="livestamp" dateTime={this.props.ticket.modifiedDate}>
                                            {this.props.ticket.modifiedDate}
                                        </time>
                                    </span>
                                </dd>
                            </dl>
                        </div>
                    </div>
                )
            }


            render() {
                const style1 = {
                    backgroundColor: '#071e4214'
                }

                const style2 = {
                    marginTop: '-5px'
                }
                return (
                    <div id="datesmodule" className="module toggle-wrap">
                        <div id="datesmodule_heading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="Dates" aria-controls="datesmodule"
                                    aria-expanded="true" onClick={this.switchDatesViewMode} style={style2}>
                                <span className="badge badge-light" style={style1}>
                                    {this.state.showDates ? <i className="fas fa-angle-down rotate-icon"></i> : <i className="fas fa-angle-right rotate-icon"></i>}
                                </span>
                            </button>
                            <h4 className="toggle-title" id="datesmodule-label">Dates</h4>
                            <ul className="ops"></ul>
                        </div>
                        {this.state.showDates ? this.renderNormalMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class TicketDetailsComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    showDetails: true,
                }
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                const style1 = {
                    backgroundColor: this.props.ticket.status.colour,
                    color: 'white',
                }
                const style2 = {
                    backgroundColor: ' #DFE1E5',
                }
                const style3 = {
                    height: "auto"
                }
                return (
                    <div className="mod-content">
                        <ul id="issuedetails" className="property-list two-cols">
                            <li className="item">
                                <div className="wrap">
                                    <strong className="name" title="Type">
                                        <label htmlFor="issuetype">Type:</label>
                                    </strong>
                                    <span id="type-val" className="value">
                                        <img alt={this.props.ticket.issueType.internalKey} height="16"
                                             src={this.props.ticket.issueType.icon}
                                             title={this.props.ticket.issueType.internalKey}
                                             width="16"></img>
                                        &nbsp;&nbsp;
                                        {this.props.ticket.issueType.internalKey}
                                    </span>
                                </div>
                            </li>
                            <li className="item item-right">
                                <div className="wrap">
                                    <strong className="name" title="Status">Status:</strong>
                                    <span id="status-val" className="value">
                                        <span
                                            className=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-yellow jira-issue-status-lozenge-indeterminate jira-issue-status-lozenge-max-width-medium"
                                            style={style1}>
                                            {this.props.ticket.status.internalKey}
                                        </span>
                                    </span>
                                </div>
                            </li>
                            <li className="item new">
                                <div className="wrap">
                                    <strong className="name" title="Priority">
                                        <label htmlFor="priority-field">Priority:</label>
                                    </strong>
                                    <span id="priority-val" className="value">
                                        <img alt={this.props.ticket.priority.internalKey} height="16"
                                             src={this.props.ticket.priority.icon}
                                             title={this.props.ticket.priority.internalKey}
                                             width="16"></img>
                                        &nbsp;&nbsp;
                                        {this.props.ticket.priority.internalKey}
                                    </span>
                                </div>
                            </li>
                            <li className="item item-right">
                                <div className="wrap">
                                    <strong className="name" title="Resolution">Resolution:</strong>
                                    <span id="resolution-val"
                                          className={"value " + this.props.ticket.resolution.internalKey}> {this.props.ticket.resolution.internalKey} </span>
                                </div>
                            </li>
                            <li className="item">
                                <div className="wrap">
                                    <strong className="name" title="Component/s">
                                        <label htmlFor="components">Component/s:</label>
                                    </strong>
                                    <span id="components-val" className="value">
                                          <span className="shorten" id="components-field" resolved=""
                                                style={style3}>
                                              {
                                                  this.props.ticket.components.map((component, i) =>
                                                      <a key={i} title="core Jenkins core"
                                                         href={"{% url 'jira:issuesListView' %}?project=" + this.props.ticket.project.internalKey + "&component=" + component.internalKey}>
                                                          {component.internalKey}&nbsp;&nbsp;
                                                      </a>
                                                  )
                                              }
                                          </span>
                                      </span>
                                </div>
                            </li>

                            <li className="item item-right">
                                <div className="wrap">
                                    <strong className="name" title="StoryPoint">Story Point:</strong>
                                    <span id="storyPoint-val" className={"value " + this.props.ticket.storyPoints}>
                                        {this.props.ticket.storyPoints}
                                    </span>
                                </div>
                            </li>

                            <li className="item">
                                <div className="wrap" id="wrap-labels">
                                    <strong className="name" title="Labels"> <label
                                        htmlFor="labels-textarea">Labels:</label> </strong>
                                    {
                                        // TODO: ticket filtering based on label is not Implemented.
                                        this.props.ticket.labels.map((label, i) =>
                                            <div className="labels-wrap value" key={i}>
                                                <a href={"{% url 'jira:issuesListView' %}?project=" + this.props.ticket.project.internalKey + "&label=" + label.internalKey}
                                                   className="aui-lozenge"
                                                   style={style2}
                                                   title={label.internalKey}>
                                                    {label.internalKey}
                                                </a>
                                            </div>
                                        )
                                    }
                                </div>
                            </li>

                            <li className="item item-right">
                                <div className="wrap">
                                    <strong className="name" title="fixVersion">Fix version:</strong>
                                    <span id="fixVersion-val" className={"value " + this.props.ticket.fixVersion}>
                                        {this.props.ticket.fixVersion}
                                    </span>
                                </div>
                            </li>
                        </ul>
                    </div>
                )
            }

            switchDetailViewMode = () => {
                this.setState({
                    showDetails: !this.state.showDetails
                })
            }

            render() {

                const style1 = {
                    backgroundColor: '#071e4214'
                }

                const style2 = {
                    marginTop: '-5px'
                }

                return (
                    <div id="details-module" className="module toggle-wrap">
                        <div id="details-module_heading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="Details"
                                    aria-controls="details-module" aria-expanded="true" onClick={this.switchDetailViewMode} style={style2}>
                                <span className="badge badge-light" style={style1}>
                                    {this.state.showDetails ? <i className="fas fa-angle-down rotate-icon"></i> : <i className="fas fa-angle-right rotate-icon"></i>}
                                </span>
                            </button>
                            <h4 className="toggle-title" id="details-module-label">Details</h4>
                            <ul className="ops"></ul>
                        </div>
                        {this.state.showDetails ? this.renderNormalMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class TicketPeopleComponent extends React.Component {
            constructor(props) {
                super(props);

                const icon = 'https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png';

                let unassignedProfile = {
                    id: 0,
                    fullName: "Unassigned",
                    icon: icon
                }

                let assignee = this.props.assignee === null ? unassignedProfile : this.props.assignee;
                let reporter = this.props.reporter === null ? unassignedProfile : this.props.reporter;
                let watchers = this.props.watchers;
                watchers.isWatching = eval(watchers.isWatching);

                this.state = {
                    assignee: assignee,
                    reporter: reporter,
                    watchers: watchers,
                    showPeople: true,
                }
            }

            switchPeopleViewMode = () => {
                this.setState({
                    showPeople: !this.state.showPeople
                })
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                return (
                    <div className="mod-content">
                        <div className="item-details people-details" id="peopledetails">
                            <dl>
                                <dt title="Assignee">
                                    <label htmlFor="assignee-field">Assignee:</label>
                                </dt>
                                <dd>
                                    <span id="assignee-val" className="view-issue-field">
                                        <span className="aui-avatar aui-avatar-small">
                                            <span className="aui-avatar-inner">
                                                <img
                                                    src={this.state.assignee.icon}
                                                    alt={this.state.assignee.fullName}></img>
                                            </span>
                                        </span>&nbsp;&nbsp;
                                        {this.state.assignee.fullName}
                                    </span>
                                </dd>
                            </dl>
                            <dl>
                                <dt title="Reporter">
                                    <label htmlFor="reporter-field">Reporter:</label>
                                </dt>
                                <dd>
                                    <span id="reporter-val" className="view-issue-field">
                                        <span className="user-hover" id="issue_summary_reporter_dumam"
                                              rel={this.state.reporter.fullName}>
                                            <span className="aui-avatar aui-avatar-small">
                                                <span className="aui-avatar-inner">
                                                    <img src={this.state.reporter.icon}
                                                         alt={this.state.reporter.fullName}></img>
                                                </span>
                                            </span>
                                            &nbsp;&nbsp;
                                            {this.state.reporter.fullName}
                                        </span>
                                    </span>
                                </dd>
                            </dl>
                        </div>
                        <div className="item-details">
                            <dl>
                                <dt title="Votes">Votes:</dt>
                                <dd>
                                    <aui-badge id="vote-data" className="">0</aui-badge>
                                    <span id="vote-label"
                                          title="You have to be logged in to vote for an issue.">&nbsp;&nbsp;Vote for this issue</span>
                                </dd>
                            </dl>
                            <dl>
                                <dt title="Watchers">Watchers:</dt>
                                <dd>
                                    {this.state.watchers.isWatching ? <span
                                            className="badge badge-pill badge-primary">{this.state.watchers.counter}</span> :
                                        <aui-badge id="watcher-data"
                                                   className="">{this.state.watchers.counter}</aui-badge>}
                                    &nbsp;
                                    <span id="watch-label"
                                          title={this.state.watchers.message}>{!this.state.watchers.isWatching ? " Watch this issue" : " Unwatch this issue"}</span>
                                </dd>
                            </dl>
                        </div>
                    </div>
                )
            }

            render() {
                const style1 = {
                    backgroundColor: '#071e4214'
                }

                const style2 = {
                    marginTop: '-5px'
                }
                return (
                    <div id="peoplemodule" className="module toggle-wrap">
                        <div id="peoplemodule_heading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="People" aria-controls="peoplemodule"
                                    aria-expanded="true" onClick={this.switchPeopleViewMode} style={style2}>
                                <span className="badge badge-light" style={style1}>
                                    {this.state.showPeople ? <i className="fas fa-angle-down rotate-icon"></i> : <i className="fas fa-angle-right rotate-icon"></i>}
                                </span>
                            </button>
                            <h4 className="toggle-title" id="peoplemodule-label">People</h4>
                            <ul className="ops"></ul>
                        </div>
                        {this.state.showPeople ? this.renderNormalMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class TicketDescriptionComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    showDescription: true,
                }
            }

            switchDescriptionViewMode = () => {
                this.setState({
                    showDescription: !this.state.showDescription
                })
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                const style1 = {
                    whiteSpace: "pre-line"
                }

                return (
                    <div className="mod-content">
                        <div id="description-val" className="field-ignore-highlight">
                            <div className="user-content-block" style={style1}>
                                {this.props.ticket.description}
                            </div>
                        </div>
                    </div>
                )
            }

            render() {
                const style1 = {
                    backgroundColor: '#071e4214'
                }

                const style2 = {
                    marginTop: '-5px'
                }
                return (
                    <div id="descriptionModule" className="module toggle-wrap">
                        <div id="descriptionModule_heading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="Description"
                                    aria-controls="descriptionModule" aria-expanded="true"
                                    onClick={this.switchDescriptionViewMode} style={style2}>
                                <span className="badge badge-light" style={style1}>
                                    {this.state.showDescription ? <i className="fas fa-angle-down rotate-icon"></i> : <i className="fas fa-angle-right rotate-icon"></i>}
                                </span>
                            </button>
                            <h4 className="toggle-title" id="descriptionmodule-label">Description</h4>
                            <ul className="ops"></ul>
                        </div>
                        {this.state.showDescription ? this.renderNormalMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class Thumbnail extends React.Component {
            constructor(props) {
                super(props);
            }

            deleteAttachment = () => {
                fetch('{% url 'jira:ticketAttachmentObjectApiEventVersion1Component' %}', {
                    method: 'DELETE',
                    headers: {
                        'Content-type': 'application/json',
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({
                        id: this.props.attachment.id,
                    }),
                }).then((response) => response.json())
                    .then((json) => {
                        if (json.success) {
                            this.props.fetchTicketAttachments();
                        }
                    })
            };

            render() {
                return (
                    <li className="attachment-content js-file-attachment" draggable="true"
                        data-downloadurl="image/png:image-2022-06-21-21-22-35-447.png:https://issues.jenkins.io/secure/attachment/58242/image-2022-06-21-21-22-35-447.png"
                        data-issue-id={this.props.attachment.id} data-attachment-type="image"
                        data-attachment-thumbnail="true">
                        <div className="attachment-thumb">
                            <a href={this.props.attachment.url}
                               title={this.props.attachment.name}
                               file-preview-id={this.props.attachment.id}
                               file-preview-title={this.props.attachment.name}
                               file-preview-type="image"
                               file-preview-url="https://issues.jenkins.io/secure/thumbnail/58242/_thumb_58242.png"
                               resolved="">
                                <img loading="lazy"
                                     src={this.props.attachment.icon}
                                     alt={this.props.attachment.name}></img>
                            </a>
                        </div>
                        <dl>
                            <dt>
                                {
                                    this.props.attachment.canDelete ?
                                        <span className="float-right"> <i className="fa fa-trash"
                                                                          onClick={this.deleteAttachment}></i> </span> :
                                        <span></span>
                                }
                                <a
                                    href={this.props.attachment.url}
                                    className="attachment-title"
                                    title={this.props.attachment.name}
                                    file-preview-id={this.props.attachment.id}
                                    file-preview-title={this.props.attachment.name}
                                    file-preview-type="image"
                                    file-preview-url="https://issues.jenkins.io/secure/thumbnail/58242/_thumb_58242.png"
                                    resolved="">{this.props.attachment.internalKey}</a></dt>
                            <dd className="attachment-size">{this.props.attachment.size}</dd>
                            <dd className="attachment-date">
                                <time className="livestamp"
                                      dateTime={this.props.attachment.createdDttm}>{this.props.attachment.createdDttm}
                                </time>
                            </dd>
                        </dl>
                    </li>
                )
            }
        }

        class TicketAttachmentComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    showAttachments: true,
                    attachments: []
                }

                this.fetchTicketAttachments = this.fetchTicketAttachments.bind(this)
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            switchAttachmentsViewMode = () => {
                this.setState({
                    showAttachments: !this.state.showAttachments
                })
            }

            componentDidMount = () => {
                this.fetchTicketAttachments();
            }

            renderNormalMode = () => {
                return (
                    <div className="mod-content">
                        <ol id="attachment_thumbnails" className="item-attachments" data-sort-key="fileName"
                            data-sort-order="asc">
                            {this.state.attachments.map((item => <Thumbnail key={item.id} attachment={item}
                                                                            fetchTicketAttachments={this.fetchTicketAttachments}/>))}
                        </ol>
                    </div>
                )
            }


            fetchTicketAttachments() {
                fetch('{% url 'jira:ticketAttachmentsApiEventVersion1Component' ticketId=ticket.id %}')
                    .then(response => response.json())
                    .then(data => this.setState({
                        attachments: data.data.attachments
                    }))

            }

            render() {
                const style1 = {
                    backgroundColor: '#071e4214'
                }

                const style2 = {
                    marginTop: '-5px'
                }

                return (
                    <div id="attachmentModule" className="module toggle-wrap">
                        <div id="attachmentModuleHeading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="Attachments"
                                    aria-controls="attachmentModule" aria-expanded="true" onClick={this.switchAttachmentsViewMode} style={style2}>
                                <span className="badge badge-light" style={style1}>
                                    {this.state.showAttachments ? <i className="fas fa-angle-down rotate-icon"></i> : <i className="fas fa-angle-right rotate-icon"></i>}
                                </span>
                            </button>
                            <h4 className="toggle-title" id="attachmentmodule-label">Attachments</h4>
                            <ul className="ops">
                                <li className="drop">
                                    <div className="aui-dd-parent">
                                        <button
                                            className="aui-button aui-button-compact aui-button-subtle js-default-dropdown"
                                            title="Options" aria-label="Attachments panel options" resolved=""
                                            id="AJS_DROPDOWN__4" aria-controls="AJS_DROPDOWN__4_drop"
                                            aria-haspopup="true" aria-expanded="false"><span
                                            className="aui-icon aui-icon-small aui-iconfont-more">Options</span>
                                        </button>
                                        <div className="aui-dropdown-content aui-list">
                                            <ul id="attachment-sorting-options" className="aui-list-section aui-first">
                                                <li className="aui-list-item"><a id="attachment-sort-key-name"
                                                                                 href="/browse/JENKINS-68799?attachmentSortBy=fileName#attachmentModule"
                                                                                 className="aui-list-checked aui-checked aui-list-item-link"
                                                                                 title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a>
                                                </li>
                                                <li className="aui-list-item"><a id="attachment-sort-key-date"
                                                                                 href="/browse/JENKINS-68799?attachmentSortBy=dateTime#attachmentModule"
                                                                                 className="aui-list-checked aui-list-item-link"
                                                                                 title="Sort By Date"><span>Sort By Date</span></a>
                                                </li>
                                            </ul>
                                            <ul id="attachment-sorting-order-options" className="aui-list-section">
                                                <li className="aui-list-item"><a id="attachment-sort-direction-asc"
                                                                                 href="/browse/JENKINS-68799?attachmentOrder=asc#attachmentModule"
                                                                                 className="aui-list-checked aui-checked aui-list-item-link"
                                                                                 title="Ascending"><span>Ascending</span></a>
                                                </li>
                                                <li className="aui-list-item"><a id="attachment-sort-direction-desc"
                                                                                 href="/browse/JENKINS-68799?attachmentOrder=desc#attachmentModule"
                                                                                 className="aui-list-checked aui-list-item-link"
                                                                                 title="Descending"><span>Descending</span></a>
                                                </li>
                                            </ul>
                                            <ul id="attachment-view-mode-options" className="aui-list-section">
                                                <li className="aui-list-item"><a id="attachment-view-mode-gallery"
                                                                                 href="/browse/JENKINS-68799?attachmentViewMode=gallery#attachmentModule"
                                                                                 className="aui-list-checked aui-checked aui-list-item-link"
                                                                                 title="Thumbnails"><span>Thumbnails</span></a>
                                                </li>
                                                <li className="aui-list-item"><a id="attachment-view-mode-list"
                                                                                 href="/browse/JENKINS-68799?attachmentViewMode=list#attachmentModule"
                                                                                 className="aui-list-checked aui-list-item-link"
                                                                                 title="List"><span>List</span></a></li>
                                            </ul>
                                            <ul id="attachment-manage-options" className="aui-list-section aui-last">
                                                <li className="aui-list-item"><a id="aszip"
                                                                                 href="/secure/attachmentzip/215653.zip"
                                                                                 className="aui-list-checked aui-list-item-link"
                                                                                 title="Download all attachments as a ZIP file"><span>Download All</span></a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            {this.state.showAttachments ? this.renderNormalMode() : this.renderEmptyMode()}
                        </div>
                    </div>
                )
            }
        }

        class TicketBar extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    assigneeIcon: this.props.ticket.assignee.icon ? this.props.ticket.assignee.icon : "https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png",
                    assigneeName: this.props.ticket.assignee.fullName ? this.props.ticket.assignee.fullName : "Unassigned"
                }
            }

            render() {
                const style1 = {
                    height: "10px"
                }
                const style2 = {
                    marginTop: "-13px",
                    marginLeft: "-10px"
                }

                const style3 = {
                    marginTop: "-12px",
                    marginLeft: "-15px"
                }

                return (
                    <div className="card grabbable" id={this.props.ticket.id}>
                        <div className="card-body" style={style1}>
                            <div className="row">
                                <div className="col-auto" style={style2}>
                                    <img src={this.props.ticket.issueType.icon} width="20" height="20"
                                         data-toggle="tooltip"
                                         data-placement="top" title={this.props.ticket.issueType.internalKey}></img>
                                </div>
                                <div className="col-auto" style={style3}>
                                    <a href={this.props.ticket.url}>{this.props.ticket.internalKey}</a>
                                </div>
                                <div className="col" style={style3}>
                                    <span>{this.props.ticket.summary}</span>
                                </div>
                                <div className="col-auto" style={style2}>
                                    <img src={this.props.ticket.priority.icon} width="20" height="20"
                                         data-toggle="tooltip"
                                         data-placement="top" title={this.props.ticket.priority.internalKey}></img>
                                </div>
                                <div className="col-auto" style={style2}>
                                    <img src={this.state.assigneeIcon} width="25" height="25"
                                         data-toggle="tooltip" data-placement="top"
                                         title={this.state.assigneeName}></img>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
        }

        class LinkingModuleHead extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    heading: this.props.isEpic ? "Issues in the epic" : "Subtasks"
                }
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                const style3 = {
                    fontSize: "24px",
                    cursor: "pointer"
                }
                return (
                    <div className="col-auto">
                        <i className="fa fa-plus-square float-right"
                           style={style3} onClick={this.props.switchCreateMode}
                        ></i>
                    </div>
                )
            }

            render() {

                const style1 = {
                    backgroundColor: '#071e4214'
                }

                const style2 = {
                    marginTop: '-5px'
                }


                return (
                    <div id="linkingmodule_heading" className="mod-header">
                        <button className="aui-button toggle-title" aria-label="Issue Links"
                                aria-controls="linkingmodule" aria-expanded="true"
                                onClick={this.props.switchTicketViewMode} style={style2}>
                            <span className="badge badge-light" style={style1}>
                                    {this.props.showTickets ? <i className="fas fa-angle-down rotate-icon"></i> :
                                        <i className="fas fa-angle-right rotate-icon"></i>}
                                </span>
                        </button>
                        <div className="row">
                            <div className="col">
                                <p className="font-weight-bold">{this.state.heading}</p>
                            </div>
                            {this.props.showTickets ? this.renderNormalMode() : this.renderEmptyMode()}

                        </div>

                    </div>
                );
            }
        }

        class LinkingModuleBody extends React.Component {
            constructor(props) {
                super(props);
                let issueTypeList = localStorage.getItem("issueTypeList");

                if (issueTypeList != null) {
                    issueTypeList = JSON.parse(issueTypeList).object;
                    const STORY = "STORY";
                    issueTypeList.sort(function (x, y) {
                        return x.code == STORY ? -1 : y.code == STORY ? 1 : 0;
                    });
                } else {
                    issueTypeList = [];
                }

                this.state = {
                    issueType: null,
                    summary: null,
                    issueTypes: issueTypeList,
                }
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            createNewTicket = () => {
                fetch('{% url 'jira:ticketObjectForEpicTicketApiEventVersion1Component' %}', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json',
                    },
                    body: JSON.stringify({
                        'ticketId': this.props.ticket.id,
                        'ticketSummary': this.refs.summaryInput.value,
                        'issueType': this.refs.issueTypeInput.value,
                    })
                }).then((response) => response.json())
                    .then((response) => {
                        if (response.success) {
                            this.props.fetchEpicTasks()
                            this.props.switchCreateMode()
                        }
                    })
            }

            createSubTask = () => {
                fetch('{% url 'jira:subTaskTicketObjectForTicketApiEventVersion1Component' %}', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json',
                    },
                    body: JSON.stringify({
                        'ticketId': this.props.ticket.id,
                        'ticketSummary': this.refs.summaryInput.value,
                    })
                }).then((response) => response.json())
                    .then((response) => {
                        if (response.success) {
                            this.props.fetchSubTasks();
                            this.props.switchCreateMode();
                        }
                    })
            }

            renderNewTicketMode = () => {
                const style1 = {
                    marginRight: "25px"
                }
                if (this.props.isEpic) {
                    return (
                        <div id="new-ticket-creator">
                            <div className="row">
                                <div className="col-4">
                                    <select id="issueType" data-show-content="true" className="form-control"
                                            ref="issueTypeInput">
                                        {this.state.issueTypes.map((type) => <option key={type.id}
                                                                                     value={type.id}
                                                                                     defaultValue={type.code}> {type.internalKey}</option>)}
{#                                       {% for ji in ticketIssueTypes %}#}
{#                                            {% if ji.code == "STORY" %}#}
{#                                                <option#}
{#                                                    data-content="<img src='{% static ji.icon %}' width='20' height='20'>&nbsp; {{ ji }}"#}
{#                                                    defaultValue="{{ ji.code }}"#}
{#                                                    selected="selected">{{ ji.internalKey }}</option>#}
{#                                            {% else %}#}
{#                                                <option#}
{#                                                    data-content="<img src='{% static ji.icon %}' width='20' height='20'>&nbsp; {{ ji }}"#}
{#                                                    defaultValue="{{ ji.code }}">{{ ji.internalKey }}</option>#}
{#                                            {% endif %}#}
{#                                        {% endfor %}#}
                                    </select>
                                </div>
                                <div className="col-8">
                                    <input className="form-control pull-right" id="new-ticket-name" type="text"
                                           ref="summaryInput"
                                           placeholder="What needs to be done?"></input>
                                </div>
                            </div>
                            <br></br>
                            <div>
                                <button type="button" className="btn btn-primary pull-right"
                                        onClick={this.createNewTicket}>Create
                                </button>
                                <button type="button" className="btn btn-light pull-right" style={style1}
                                        onClick={this.props.switchCreateMode}>Cancel
                                </button>
                            </div>
                        </div>
                    )
                } else {
                    return (
                        <div id="subtask-tickets-container">
                            <div id="subtask-tickets-creator">
                                <input className="form-control" id="new-sub-task-name" type="text" ref="summaryInput"
                                       placeholder="What needs to be done in this sub task?"></input>
                                <br></br>
                                <button type="button" className="btn btn-primary pull-right"
                                        onClick={this.createSubTask}>Create
                                </button>
                                <button type="button" className="btn btn-light pull-right" style={style1}
                                        onClick={this.props.switchCreateMode}>Cancel
                                </button>
                            </div>
                        </div>
                    )
                }
            }

            renderListMode = () => {
                return (
                    <span>
                    {this.props.isEpic ? this.props.epicTickets.map((ticket) => <TicketBar key={ticket.id}
                                                                                           ticket={ticket}/>) : this.props.subTaskTickets.map((ticket) =>
                        <TicketBar key={ticket.id} ticket={ticket}/>)}
                        </span>
                )
            }

            render() {
                return (
                    <div id="tickets-list-container">
                        {this.props.showTickets ? this.renderListMode() : this.renderEmptyMode()}
                        {this.props.inCreateMode ? this.renderNewTicketMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class LinkingModuleComponent extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    isEpic: this.props.ticket.issueType.internalKey === 'Epic',
                    inCreateMode: false,
                    epicTickets: [],
                    subTaskTickets: [],
                    showTickets: true,
                }

                this.switchCreateMode = this.switchCreateMode.bind(this)
                this.fetchEpicTasks = this.fetchEpicTasks.bind(this)
                this.fetchSubTasks = this.fetchSubTasks.bind(this)
                this.switchTicketViewMode = this.switchTicketViewMode.bind(this)
            }

            switchTicketViewMode = () => {
                this.setState({
                    showTickets: !this.state.showTickets
                })
            }

            componentDidMount = () => {
                if (this.state.isEpic)
                    this.fetchEpicTasks()
                else
                    this.fetchSubTasks()
            }

            fetchEpicTasks() {
                fetch('{% url 'jira:ticketsForEpicTicketApiEventVersion1Component' ticketId=ticket.id %}')
                    .then(response => response.json())
                    .then(data => this.setState({
                        epicTickets: data.data.tickets
                    }))
            }

            fetchSubTasks() {
                fetch('{% url 'jira:subTaskTicketsForTicketApiEventVersion1Component' ticketId=ticket.id %}')
                    .then(response => response.json())
                    .then(data => this.setState({
                        subTaskTickets: data.data.tickets
                    }))
            }

            switchCreateMode = () => {
                this.setState({
                    inCreateMode: !this.state.inCreateMode
                })
            }

            render() {
                return (
                    <div id="linkingmodule" className="module toggle-wrap">
                        <LinkingModuleHead isEpic={this.state.isEpic} inCreateMode={this.state.inCreateMode}
                                           switchCreateMode={this.switchCreateMode}
                                           showTickets={this.state.showTickets}
                                           switchTicketViewMode={this.switchTicketViewMode}/>
                        <br></br>
                        <LinkingModuleBody isEpic={this.state.isEpic} inCreateMode={this.state.inCreateMode}
                                           switchCreateMode={this.switchCreateMode} epicTickets={this.state.epicTickets}
                                           fetchEpicTasks={this.fetchEpicTasks} fetchSubTasks={this.fetchSubTasks}
                                           subTaskTickets={this.state.subTaskTickets} ticket={this.props.ticket}
                                           showTickets={this.state.showTickets}
                                           switchTicketViewMode={this.switchTicketViewMode}/>
                    </div>
                );
            }
        }

        class TicketCommentInstanceComponent extends React.Component {
            constructor(props) {
                super(props);
                // commentMode: VIEW, EDIT, HIDE

                this.state = {
                    commentMode: 'VIEW',
                    editDeleteDisplay: 'none'
                }
            }

            renderCommentByMode = () => {
                if (this.state.commentMode === 'HIDE')
                    return this.renderEmptyMode();
                else if (this.state.commentMode === 'VIEW')
                    return this.renderViewMode();
                else if (this.state.commentMode === 'EDIT')
                    return this.renderEditMode();
            }

            onMouseEnter = () => {
                this.setState({
                    editDeleteDisplay: ''
                })
            }

            onMouseLeave = () => {
                this.setState({
                    editDeleteDisplay: 'none'
                })
            }

            deleteComment = (commentId) => {
                fetch('{% url 'jira:ticketCommentObjectApiEventVersion1Component' %}', {
                    method: 'DELETE',
                    headers: {
                        'Content-type': 'application/json',
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({
                        id: commentId,
                    }),
                }).then((response) => response.json())
                    .then((json) => {
                        if (json.success) {
                            this.props.fetchComments();
                        }
                    })
            }

            updateComment = () => {
                let comment = this.refs.newCommentValue.value;
                let id = this.props.comment.id;

                fetch('{% url 'jira:ticketCommentObjectApiEventVersion1Component' %}', {
                    method: 'PUT',
                    headers: {
                        'Content-type': 'application/json',
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({
                        id: id,
                        comment: comment,
                    })
                }).then((response) => response.json())
                    .then((json) => {
                        if (json.success) {
                            this.props.fetchComments();
                            this.setCommentMode('VIEW');
                        }
                    })
            }

            generateRandomNumber = () => {
                return Math.floor(Math.random() * 10000)
            }

            setCommentMode = (mode) => {
                this.setState({
                    commentMode: mode
                })
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderViewMode = () => {
                {
                    this.props.comment.comment.split('\n').map(str => <p
                        key={"comment-" + this.props.comment.id + "-" + this.generateRandomNumber()}>{str}</p>)
                }
                return (
                    <div className="action-body flooded"><span>
                        {
                            this.props.comment.comment.split(/\r\n|\r|\n/).map((str) => <p
                                key={"comment-" + this.props.comment.id + "-" + this.generateRandomNumber()}>{str}</p>)
                        }
                    </span></div>
                )
            }

            renderEditMode = () => {

                const style1 = {
                    color: "white",
                    backgroundColor: "#0052cc",
                }

                const style2 = {
                    marginRight: "10px",
                    backgroundColor: "#f5f6f8",
                }

                const numberOfParagraphs = this.props.comment.comment.split(/\r\n|\r|\n/).length;
                return (
                    <div className="form-group">
                        <textarea className="form-control" defaultValue={this.props.comment.comment}
                                  rows={numberOfParagraphs} ref="newCommentValue"></textarea>
                        <br></br>
                        <button type="button" className="btn float-right" onClick={this.updateComment}
                                style={style1}>Update
                        </button>
                        <span></span>
                        <button type="button" className="btn float-right"
                                style={style2} onClick={() => { this.setCommentMode('VIEW') }}>Cancel
                        </button>
                    </div>
                )
            }

            render() {
                const style1 = {
                    backgroundColor: '#071e4214'
                }

                const style2 = {
                    marginTop: '-5px'
                }

                const style3 = {
                    display: this.state.editDeleteDisplay
                }
                return (
                    <div id={"comment-" + this.props.comment.id}
                         className="issue-data-block activity-comment twixi-block expanded">
                        <div className="twixi-wrap verbose actionContainer">
                            <div className="action-head">
                                <button aria-label="Collapse comment" title="Collapse comment"
                                        className="aui-button toggle-title" aria-expanded="true"
                                        onClick={() => { this.setCommentMode(this.state.commentMode === 'HIDE' ? 'VIEW' : 'HIDE') }} style={style2}>
                                    <span className="badge badge-light" style={style1}>
                                    {this.state.commentMode === 'VIEW' ? <i className="fas fa-angle-down rotate-icon"></i> :
                                        <i className="fas fa-angle-right rotate-icon"></i>}
                                </span>
                                </button>
                                <div className="action-details">
                                    <a className="user-hover user-avatar" rel="7ad1551c39c0"
                                       id="commentauthor_2600002_verbose"
                                       href="/secure/ViewProfile.jspa?name=7ad1551c39c0"><span
                                        className="aui-avatar aui-avatar-xsmall"><span className="aui-avatar-inner"><img
                                        src={this.props.comment.creator.icon}
                                        alt="https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png"></img></span></span> {this.props.comment.creator.fullName}
                                    </a>
                                    &nbsp;added a comment at <a
                                    href="/browse/JSDCLOUD-9247?focusedCommentId=2600002&amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-2600002"
                                    className="commentdate_2600002_verbose subText comment-created-date-link"><span
                                    className="date user-tz" title={this.props.comment.createdDttm}>
                                    <time className="livestamp"
                                          dateTime={this.props.comment.createdDttm}>{this.props.comment.createdDttm}</time></span></a>
                                    &nbsp;&nbsp;{this.props.comment.edited ?
                                    <span className="text-secondary">(edited)</span> : <span></span>}
                                    &nbsp;
                                    {
                                        this.props.comment.canEdit ?
                                            <span onMouseEnter={this.onMouseEnter} onMouseLeave={this.onMouseLeave}>
                                        <i className="fa fa-trash" style={style3} onClick={() => {
                                            this.deleteComment(this.props.comment.id)
                                        }}></i>
                                                &nbsp;&nbsp;
                                                <i className="fa fa-edit" style={style3} onClick={() => {
                                                    this.setCommentMode(this.state.commentMode === 'EDIT' ? 'VIEW' : 'EDIT')
                                                }}></i>
                                    </span> : <span></span>
                                    }

                                </div>
                            </div>
                            {this.renderCommentByMode()}
                            <div className="action-links action-comment-actions">
                            </div>
                        </div>
                    </div>
                )
            }
        }

        class ActivityModuleBody extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    inCreateMode: false,
                }
            }

            switchCreateMode = () => {
                this.setState({
                    inCreateMode: !this.state.inCreateMode
                })
            }

            renderNormalMode = () => {
                const style1 = {
                    backgroundColor: '#f5f6f8'
                }
                return <button type="button" className="btn" style={style1} onClick={this.switchCreateMode}>Add
                    comment</button>
            }

            createNewComment = () => {
                if (this.refs.comment.value && !this.refs.comment.value.trim() || this.refs.comment.value.length === 0)
                    return;

                fetch('{% url 'jira:ticketCommentObjectApiEventVersion1Component' %}', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json',
                    },
                    body: JSON.stringify({
                        'ticketId': this.props.ticket.id,
                        'comment': this.refs.comment.value,
                    })
                }).then((response) => {
                    switch (response.status) {
                        case 200:
                            this.props.fetchComments();
                            break;
                        case 401:
                            Swal.fire(
                                {
                                    icon: 'error',
                                    title: "Can't do that!",
                                    text: 'Please login to add a comment'
                                }
                            );
                            break;
                        default:
                            Swal.fire(
                                {
                                    icon: 'error',
                                    title: "Can't do that!",
                                    text: 'Unable to perform this action'
                                }
                            );
                    }

                })

                this.switchCreateMode();
            }

            renderNewCommentMode = () => {

                const style1 = {
                    color: "white",
                    backgroundColor: "#0052cc",
                }

                const style2 = {
                    marginRight: "10px",
                    backgroundColor: "#f5f6f8",
                }
                return (
                    <div className="className-group">
                        <textarea className="form-control" id="commentBox" placeholder="Write comment here..."
                                  rows="4" ref="comment"></textarea>
                        <br></br>
                        <button type="button" className="btn float-right" onClick={this.createNewComment}
                                style={style1}>Submit
                        </button>
                        <span></span>
                        <button type="button" className="btn float-right" onClick={this.switchCreateMode}
                                style={style2}>Cancel
                        </button>
                    </div>
                );
            }

            render() {

                return (
                    <div id="ticket-comment-list-container">
                        {this.props.comments.map((comment) => <TicketCommentInstanceComponent key={comment.id}
                                                                                              comment={comment}
                                                                                              fetchComments={this.props.fetchComments}/>)}
                        <br></br>
                        <br></br>
                        {this.state.inCreateMode ? this.renderNewCommentMode() : this.renderNormalMode()}
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                        <br></br>
                    </div>
                )
            }

        }


        class TicketActivityModuleComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    showComments: true,
                    comments: []
                }
                this.fetchComments = this.fetchComments.bind(this)
            }

            switchCommentsViewMode = () => {
                this.setState({
                    showComments: !this.state.showComments
                })
            }

            componentDidMount = () => {
                this.fetchComments();
            }

            fetchComments() {
                fetch('{% url 'jira:ticketCommentsApiEventVersion1Component' ticketId=ticket.id %}')
                    .then(response => response.json())
                    .then(data => this.setState({
                        comments: data.data.comments
                    }))
            }

            renderEmptyMode = () => {
                return <div></div>
            }

            renderNormalMode = () => {
                return (
                    <ActivityModuleBody
                        comments={this.state.comments}
                        fetchComments={this.fetchComments}
                        ticket={this.props.ticket}/>
                )
            }

            render() {
                const style1 = {
                    backgroundColor: '#071e4214'
                }

                const style2 = {
                    marginTop: '-5px'
                }

                return (
                    <div id="activitymodule" className="module toggle-wrap">
                        <div id="activitymodule_heading" className="mod-header">
                            <button className="aui-button toggle-title" aria-label="Activity"
                                    aria-controls="activitymodule" aria-expanded="true"
                                    onClick={this.switchCommentsViewMode} style={style2}>
                            <span className="badge badge-light" style={style1}>
                                    {this.state.showComments ? <i className="fas fa-angle-down rotate-icon"></i> :
                                        <i className="fas fa-angle-right rotate-icon"></i>}
                                </span>
                            </button>
                            <div className="row">
                                <div className="col">
                                    <p className="font-weight-bold">Comments</p>
                                </div>
                            </div>
                        </div>
                        <br></br>
                        {this.state.showComments ? this.renderNormalMode() : this.renderEmptyMode()}
                    </div>
                )
            }
        }

        class TicketViewComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    ticket: null
                }

                this.fetchTicketDetails = this.fetchTicketDetails.bind(this)
            }

            fetchTicketDetails = () => {
                fetch('{% url 'jira:ticketObjectDetailApiEventVersion1Component' ticketId=ticket.id%}', {
                    method: 'GET',
                }).then((response) => response.json())
                    .then((json) => {
                        this.setState({
                            ticket: json.data
                        })
                    })
            }

            componentDidMount = () => {
                this.fetchTicketDetails();
            }

            renderNormalMode = () => {
                return (
                    <div>
                        <TicketHeaderComponent ticket={this.state.ticket} fetchTicketDetails={this.fetchTicketDetails}/>
                        <div className="issue-body-content">
                            <div className="aui-group issue-body">

                                <div className="aui-item issue-main-column">
                                    <TicketDetailsComponent ticket={this.state.ticket}/>
                                    <TicketDescriptionComponent ticket={this.state.ticket}/>
                                    <TicketAttachmentComponent ticket={this.state.ticket}/>
                                    <LinkingModuleComponent ticket={this.state.ticket}/>
                                    <TicketActivityModuleComponent ticket={this.state.ticket}/>
                                </div>

                                <div id="view-issue-sidebar" className="aui-item issue-side-column">
                                    <TicketPeopleComponent assignee={this.state.ticket.assignee}
                                                           reporter={this.state.ticket.reporter}
                                                           watchers={this.state.ticket.watchers}/>
                                    <TicketDatesComponent ticket={this.state.ticket}/>
                                </div>

                            </div>
                        </div>
                    </div>
                )
            }

            renderEmptyMode = () => {
                return <div></div>
            }


            render() {
                return (
                    <div>
                        {this.state.ticket === null ? this.renderEmptyMode() : this.renderNormalMode()}
                    </div>
                )
            }
        }

        ReactDOM.render(<TicketViewComponent/>, document.getElementById('issue-content'));
    </script>

{#    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>#}
{#    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>#}
{% endblock %}