{% extends "accounts/base.html" %}
{% load static %}
{% block content %}
    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardCSS1.css' %}">
    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardCSS2.css' %}">

    <link type="text/css" rel="stylesheet" href="{% static 'css/boardSettingsCSS1.css' %}">
    <link type="text/css" rel="stylesheet" href="{% static 'css/boardSettingsCSS2.css' %}">

    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <style>
        #ghx-mapping {
            max-width: 98%
        }
    </style>

    <body class=" ghx-agile ghx-rapid-views aui-page-sidebar aui-sidebar-collapsed ghx-scroll-columns ">
    <div id="page">
        <div id="announcement-banner" class="alertHeader">
        </div>
        <div id="content">
            <section class="aui-sidebar projects-sidebar fade-in" resolved="" aria-expanded="false" id="sidebar"
                     aria-label="Sidebar">
                <div class="aui-sidebar-wrapper" style="height: 583px;">
                    <div class="col" style="margin-top: 10px">

                        <ul class="navbar-nav mr-auto">
                            <li class="nav-item active">
                                <a class="nav-link" href="{% url 'jira:board-settings' url=board.url %}"
                                   data-toggle="tooltip"
                                   data-placement="right" title="Settings"><i style="font-size:24px"
                                                                              class="fa">&#xf085;</i></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'jira:board-page' url=board.url %}"
                                   data-toggle="tooltip"
                                   data-placement="right" title="Board"><i style='font-size:24px'
                                                                           class='far'>&#xf24d;</i></a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown" href="#" id="navbarDropdown" role="button"
                                   data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                   title="Boards in this project">
                                    <i style='font-size:24px'
                                       class='far'>&#xf24d;</i>
                                </a>
                                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    {% for otherBoard in boardsInProject %}
                                        <a class="dropdown-item"
                                           href="{{ otherBoard.getUrl }}">{{ otherBoard.internalKey }}</a>
                                    {% endfor %}
                                </div>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'jira:board-backlog' url=board.url %}"
                                   data-toggle="tooltip"
                                   data-placement="right" title="Backlog"><i style="font-size:24px"
                                                                             class="fas fa-tasks"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
            <main role="main" id="main" class="ghx-gh  aui-page-panel">
                <div id="gh" class="ghx-no-touch">
                    <div id="ghx-header">
                        <div id="ghx-modes-tools">
                            <div id="ghx-view-modes" style=""></div>
                            <span id="ghx-view-pluggable" style="visibility: visible;">
                                        <div class="btn-group ghx-view-section">
                                            <button id="board-tools-section-button" type="button"
                                                    class="btn aui-button dropdown-toggle" data-toggle="dropdown"
                                                    aria-haspopup="true"
                                                    aria-expanded="false">
                                                Board
                                            </button>
                                            <div class="dropdown-menu">
                                                <a class="dropdown-item"
                                                   href="{% url 'jira:board-settings' url=board.url %}">Settings</a>
                                            </div>
                                        </div>
                                    </span>
                            <div id="ghx-view-tools"></div>
                            <div id="ghx-view-presentation">
                                <button class="aui-button ghx-compact-toggle js-compact-toggle"
                                        title="Hide the header ( Z )" aria-label="Hide the header" resolved=""><span
                                        class="aui-icon aui-icon aui-icon-small aui-iconfont-vid-full-screen-on"></span>
                                </button>
                            </div>
                        </div>
                        <div id="ghx-view-selector">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb" style="background-color: transparent;">
                                    <li class="breadcrumb-item"><a href="{% url 'jira:boards-page' %}">Boards</a></li>
                                    <li class="breadcrumb-item" active><a
                                            href="{{ board.getUrl }}">{{ board.internalKey }} Board</a></li>
                                </ol>
                            </nav>
                            <h1>
                                <!-- <span id="ghx-board-name" class="subnav-page-header">WA PET Board</span> -->
                                <span class="subnav-container">
                                        <span id="subnav-title">
                                          <span class="subnavigator-title"
                                                title="Kanban board">{{ board.internalKey }} board</span>
                                        </span>
                                        <span id="subnav-trigger"></span>
                                        <span id="subnav-opts"></span>
                                      </span>
                            </h1>
                        </div>
                    </div>
                    <div id="ghx-content-main" class="ghx-content-main">
                        <div id="ghx-errors"></div>
                        <div id="ghx-notify" style="display: none;"></div>
                        <div id="ghx-rabid" style="">
                            <div id="ghx-operations">
                                <div id="ghx-controls">
                                    <div id="ghx-controls-plan" class="ghx-controls-plan ghx-controls-list"
                                         style="display: none;"></div>
                                    <div id="ghx-controls-work" class="ghx-controls-work ghx-controls-list">
                                        <div class="ghx-controls-filters js-quickfilter-selector">
                                            <dl id="js-work-quickfilters"
                                                class="aui-expander-content ghx-quick-content">
                                                <dt id="js-quickfilters-label" class="ghx-cursor-help"
                                                    title="Use Quick Filters to view a subset of issues. Board owners can add more.">
                                                    Quick Filters:
                                                </dt>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link first  "
                                                       title="Displays only WA_PET Tickets for specific duration (PET_LIVE_SUPPORT + PET_TECH_IMPROVMENT"
                                                       data-filter-id="13911" resolved="">Reports - Created in Last
                                                    week</a></dd>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link   "
                                                       title="assignee = Name.Name " data-filter-id="13090" resolved="">Name</a>
                                                </dd>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link   "
                                                       title="assignee = Name.Name " data-filter-id="13009" resolved="">Name</a>
                                                </dd>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link   "
                                                       title="Displays issues which are currently assigned to the current user"
                                                       data-filter-id="12956" resolved="">Only My Issues</a></dd>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link  last "
                                                       title="Displays issues which have been updated in the last day"
                                                       data-filter-id="12957" resolved="">Recently Updated</a></dd>
                                                <dd class="ghx-quickfilter-trigger" style="display: none;"><a
                                                        id="js-work-quickfilters-trigger"
                                                        data-replace-text="Ã¢â‚¬Â¦ Show fewer"
                                                        class="aui-expander-trigger"
                                                        aria-controls="js-work-quickfilters">Ã¢â‚¬Â¦ Show more</a></dd>
                                            </dl>
                                        </div>
                                        <button class="aui-button ghx-compact-toggle js-compact-toggle"
                                                title="Show the header ( Z )" aria-label="Show the header" resolved="">
                                            <span class="aui-icon aui-icon aui-icon-small aui-iconfont-vid-full-screen-off"></span>
                                        </button>
                                    </div>
                                    <div id="ghx-controls-report" class="ghx-controls-report"
                                         style="display: none;"></div>
                                </div>
                            </div>
                            <div id="ghx-plan" style="display: none;"></div>
                            <div id="ghx-report" class="ghx-chart" style="display: none;"></div>
                            <div id="ghx-work" class="ghx-work">
                                <div id="ghx-pool-column">
                                </div>
                                <div id="ghx-detail-view" class="ghx-detail-view gh-editable-detail-view"
                                     style="width: 400px; display: none;"></div>
                            </div>
                            <div id="ghx-team"></div>
                        </div>
                    </div>
                    <div class="ghx-throbber"></div>
                </div>
            </main>
        </div>
    </div>
    </body>

    <script type="text/babel">

        class ColumnStatusInstanceComponent extends React.Component {
            constructor(props) {
                super(props);

                let lozenge = null;

                if (this.props.status.category === "TODO") {
                    lozenge = "jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-blue-gray jira-issue-status-lozenge-new aui-lozenge-subtle jira-issue-status-lozenge-max-width-long";
                } else if (this.props.status.category === "IN_PROGRESS" || this.props.status.category === null) {
                    lozenge = "jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-yellow jira-issue-status-lozenge-indeterminate aui-lozenge-subtle jira-issue-status-lozenge-max-width-long";
                } else if (this.props.status.category === "DONE") {
                    lozenge = "jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-long";
                }

                this.state = {
                    lozenge: lozenge
                }
            }

            render() {
                return (
                    <li id={this.props.status.id}>
                        <div className="ghx-status" data-statusid={this.props.status.id}>
                            <div className="ghx-name">
                                {#<div className="ghx-lozenge-wrap">#}
                                <div>
                                            <span
                                                className={this.state.lozenge}
                                                aria-describedby="aui-tooltip">{this.props.status.internalKey}</span>
                                </div>
                            </div>
                            <br></br>
                            <div className="row">
                                <div className="ghx-qty col">150 issues</div>
                                <div className="ghx-done col-auto">
                                    <input id="resolution-update-11609"
                                           className="js-resolution-update"
                                           title="Tick to set the resolution to 'Done' when an issue is transitioned to this status"
                                           type="checkbox" disabled={true}>
                                    </input>
                                    <label>
                                        <span className="ghx-resolution-update-disabled">Set resolution</span>
                                    </label>
                                </div>
                            </div>
                            <div className="ghx-actions"></div>
                        </div>
                    </li>
                )
            }
        }


        class ColumnInstanceComponent extends React.Component {
            constructor(props) {
                super(props);
            }

            componentDidMount = () => {
                $(".connectedSortable").sortable({
                    connectWith: ".connectedSortable",
                    dropOnEmpty: true
                }).disableSelection();
            }

            render() {

                const style1 = {
                    backgroundColor: this.props.column.colour
                }

                const style2 = {
                    minHeight: "10px"
                }
                return (
                    <ul className="ghx-column-wrapper ghx-config-status ghx-mapped card"
                        data-column-id={this.props.column.id} id={this.props.column.id}>
                        <li className="ghx-header">
                            <div className="ghx-config-operator">
                                <div className="ghx-action ghx-config-move"></div>
                                <div className="ghx-action ghx-config-delete" data-deleteindex="1"><span
                                    className="aui-icon aui-icon-small aui-iconfont-delete js-column-delete"></span>
                                </div>
                            </div>
                            <h3 className="ghx-header-name" data-arialabel="Column name"
                                data-fieldname="name"
                                data-fieldvalue={this.props.column.internalKey}
                                title={this.props.column.internalKey}>{this.props.column.internalKey}</h3>
                            <div className="ghx-border-bottom" style={style1}></div>
                        </li>
                        <div className="connectedSortable" style={style2}
                             id={"listOfColumnStatusInstanceComponent-" + this.props.column.id}>
                            {this.props.column.columnStatusGroups.map((status) => <ColumnStatusInstanceComponent
                                key={status.id} status={status}/>)}
                        </div>
                    </ul>
                )
            }
        }

        class ColumnGroupComponent extends React.Component {

            constructor(props) {
                super(props);

                this.state = {
                    columnGroups: [],
                    unMappedStatusColumn: null,
                }
            }

            fetchAgileBoardColumn = () => {
                fetch('{% url 'jira:agileBoardColumnOperationApiEventVersion1Component' boardId=board.id%}', {
                    method: 'GET',
                }).then((response) => response.json())
                    .then((json) => {
                        this.setState({
                            columnGroups: json.data.columnGroups,
                            unMappedStatusColumn: json.data.unMappedStatusColumn
                        })
                    })
            }

            componentDidMount = () => {
                this.fetchAgileBoardColumn();

                $("#ghx-mapping-columns").sortable({
                    revert: true
                });
            }

            createColumnInstance = () => {

                let name = this.refs.columnNameInput.value;
                let category = this.refs.columnCategoryInput.value;

                fetch('{% url 'jira:agileBoardColumnOperationApiEventVersion1Component' boardId=board.id%}', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json',
                    },
                    body: JSON.stringify({
                        'function': 'CREATE_BOARD_COLUMN',
                        'name': name,
                        'category': category,
                    })
                }).then((response) => response.json())
                    .then((json) => {
                        this.fetchAgileBoardColumn();
                    })

                this.resetAddColumnModal();

            }

            createStatusInstance = () => {
                let name = this.refs.statusNameInput.value;
                let category = this.refs.statusCategoryInput.value;

                fetch('{% url 'jira:agileBoardColumnOperationApiEventVersion1Component' boardId=board.id%}', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json',
                    },
                    body: JSON.stringify({
                        'function': 'CREATE_COLUMN_STATUS',
                        'name': name,
                        'category': category,
                    })
                }).then((response) => response.json())
                    .then((json) => {
                        this.fetchAgileBoardColumn();
                    })

                this.resetAddStatusModal();
            }

            resetAddColumnModal = () => {
                this.refs.columnNameInput.value = "";
            }

            resetAddStatusModal = () => {
                this.refs.statusNameInput.value = "";
            }

            saveBoard = () => {
                // get all the columns and status for each column.
                let boardUpdate = [];
                const boardColumnsInOrder = $.map($('#ghx-mapping-columns > ul'), ul => ul.id);

                for (const item of boardColumnsInOrder) {

                    let statusIds = $.map($(`#listOfColumnStatusInstanceComponent-${item} > li`), li => li.id);

                    boardUpdate.push(
                        {
                            columnId: item,
                            statusIds: statusIds
                        }
                    );
                }


                console.log(boardUpdate)

                $.ajax(
                    {
                        url: "{% url 'jira:agileBoardColumnOperationApiEventVersion1Component' boardId=board.id%}",
                        data:
                            {
                                columnAndStatus: JSON.stringify(boardUpdate),
                            },
                        type: 'PUT',
                        dataType: 'json',
                        success: function (response) {
                            if (response.success) {
                                //window.location.reload();
                            }
                        }
                    });
            }

            render() {

                const style1 = {
                    minHeight: "45px",
                }

                const style2 = {
                    minHeight: "10px",
                }
                const style3 = {
                    marginRight: "40px",
                }

                const style4 = {
                    maxWidth: "300px",
                }
                return (
                    <div>
                        <div className="modal fade" id="addColumnModal" tabIndex="-1" role="dialog"
                             aria-labelledby="addColumnModalLabel" aria-hidden="true">
                            <div className="modal-dialog" role="document">
                                <div className="modal-content">
                                    <div className="modal-header">
                                        <h3 className="modal-title">Add column</h3>
                                        <button type="button" className="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div className="modal-body">
                                        <div className="form-group">
                                            <label htmlFor="columnName">Name</label>
                                            <input type="text" className="form-control" id="columnName"
                                                   ref="columnNameInput"></input>
                                        </div>
                                        <div className="form-group">
                                            <label htmlFor="columnCategory">Category</label>
                                            <select className="form-control" id="columnCategory"
                                                    defaultValue="IN_PROGRESS" ref="columnCategoryInput">
                                                <option value="TODO">To Do</option>
                                                <option value="IN_PROGRESS" selected>In progress</option>
                                                <option value="DONE">Done</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="modal-footer">
                                        <button type="button" className="btn btn-light" data-dismiss="modal"
                                                onClick={this.createColumnInstance}>Add
                                        </button>
                                        <button type="button" className="btn btn-danger" data-dismiss="modal"
                                                onClick={this.resetAddColumnModal}>Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style={style2}></div>

                        <div className="modal fade" id="addStatusModal" tabIndex="-1" role="dialog"
                             aria-labelledby="addStatusModalLabel" aria-hidden="true">
                            <div className="modal-dialog" role="document">
                                <div className="modal-content">
                                    <div className="modal-header">
                                        <h3 className="modal-title">Add status</h3>
                                        <button type="button" className="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div className="modal-body">
                                        <div className="form-group">
                                            <label htmlFor="statusName">Name</label>
                                            <input type="text" className="form-control" id="statusName"
                                                   ref="statusNameInput"></input>
                                        </div>
                                        <div className="form-group">
                                            <label htmlFor="statusCategory">Category</label>
                                            <select className="form-control" id="statusCategory"
                                                    defaultValue="IN_PROGRESS" ref="statusCategoryInput">
                                                <option value="TODO">To Do</option>
                                                <option value="IN_PROGRESS" selected>In progress</option>
                                                <option value="DONE">Done</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="modal-footer">
                                        <button type="button" className="btn btn-light" data-dismiss="modal"
                                                onClick={this.createStatusInstance}>Add
                                        </button>
                                        <button type="button" className="btn btn-danger" data-dismiss="modal"
                                                onClick={this.resetAddStatusModal}>Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" className="btn aui-button float-right" hidden></button>
                        <button type="button" className="btn aui-button float-right" style={style3}
                                onClick={this.saveBoard}>Save Board
                        </button>
                        <button type="button" className="btn aui-button float-right" data-toggle="modal"
                                data-target="#addStatusModal">Add Status
                        </button>
                        <button type="button" className="btn aui-button float-right" data-toggle="modal"
                                data-target="#addColumnModal">Add Column
                        </button>
                        <div style={style1}></div>
                        <div id="ghx-mapping" data-last-updated="1661583240833" className="container-fluid">

                            <div id="ghx-mapping-columns-wrapper">

                                <div id="ghx-mapping-columns">
                                    {this.state.columnGroups.map((column) => <ColumnInstanceComponent key={column.id}
                                                                                                      column={column}/>)}
                                    {
                                        this.state.unMappedStatusColumn != null ?
                                            <ColumnInstanceComponent column={this.state.unMappedStatusColumn}/> :
                                            <span></span>
                                    }
                                </div>
                            </div>

                        </div>
                    </div>

                )
            }

        }

        ReactDOM.render(<ColumnGroupComponent/>, document.getElementById('ghx-pool-column'));
    </script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

{% endblock %}