{% extends "accounts/base.html" %}
{% load jiraTags %}
{% load static %}
{% block content %}
    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardCSS1.css' %}">
    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardCSS2.css' %}">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css"/>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>

    <div class="modal fade" id="addComponentModal" tabindex="-1" role="dialog"
         aria-labelledby="addComponentModalLabel">
        <div class="modal-dialog" role="document">
            <form method="post">
                {% csrf_token %}
                <input hidden name="addProjectComponent">
                <div class="modal-content">
                    <div class="modal-header"><h3 class="modal-title">Add component</h3>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">×</span></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="internalKey">Name</label>
                            <select class="form-control componentInternalKey" id="componentInternalKeyA" name="internalKey" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="description">Description (optional)</label>
                            <textarea class="form-control col" rows="3" placeholder="Description"
                                      name="description"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" class="btn" style="background-color: #0052cc; color: white;" value="Add">
                        <button type="button" class="btn" data-dismiss="modal"
                                style="background-color: rgb(235, 236, 240);">Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="editComponentModal" tabindex="-1" role="dialog"
         aria-labelledby="editComponentModalLabel">
        <div class="modal-dialog" role="document">
            <form method="post">
                {% csrf_token %}
                <input hidden name="editProjectComponent">
                <div class="modal-content">
                    <div class="modal-header"><h3 class="modal-title">Add component</h3>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">×</span></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="internalKey">Name</label>
                            <select class="form-control componentInternalKey" name="internalKey" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="description">Description (optional)</label>
                            <textarea class="form-control col" rows="3" placeholder="Description" id="descriptionEdit"
                                      name="description"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" class="btn" style="background-color: #0052cc; color: white;" value="Update">
                        <button type="button" class="btn" data-dismiss="modal"
                                style="background-color: rgb(235, 236, 240);">Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <form method="post" hidden>
        {% csrf_token %}
        <input name="archiveProjectComponentId" id="archiveProjectComponentId" hidden>
        <input name="archiveProjectComponent" hidden>
        <input type="submit" id="submitArchiveProjectComponent">
    </form>

    <form method="post" hidden>
        {% csrf_token %}
        <input name="deleteProjectComponentId" id="deleteProjectComponentId" hidden>
        <input name="deleteProjectComponent" hidden>
        <input type="submit" id="submitDeleteProjectComponent">
    </form>


    <body class=" ghx-agile ghx-rapid-views aui-page-sidebar aui-sidebar-collapsed ghx-scroll-columns ">
    <div id="page">
        <div id="announcement-banner" class="alertHeader">
        </div>
        <div id="content">
            <section class="aui-sidebar projects-sidebar fade-in" resolved="" aria-expanded="false" id="sidebar"
                     aria-label="Sidebar">
                <div class="aui-sidebar-wrapper" style="height: 583px;">
                    <div class="col" style="margin-top: 10px">
                    </div>
                </div>
            </section>
            <main role="main" id="main" class="ghx-gh  aui-page-panel">
                <div id="gh" class="ghx-no-touch">
                    <div id="ghx-header">
                        <div id="ghx-modes-tools">
                            <div id="ghx-view-modes" style=""></div>
                            <span id="ghx-view-pluggable" style="visibility: visible;">

                            <div class="btn-group ghx-view-section">
                                <button type="button" class="btn" data-toggle="modal" data-target="#addComponentModal"
                                        style="background-color: #0052cc; color: white;" onclick="updateInternalKeyOptions(null)">Create Component</button>
                            </div>
                        </span>
                        </div>
                        <div id="ghx-view-selector">

                            <h1>
                                <span class="subnav-container">
                                    <span id="subnav-title">
                                        <span class="subnavigator-title" title="components">Components</span>
                                    </span>
                                </span>
                            </h1>
                        </div>
                    </div>
                    <div id="ghx-content-main" class="ghx-content-main">
                        <div id="ghx-errors"></div>
                        <div id="ghx-notify" style="display: none;"></div>
                        <div id="ghx-rabid" style="">
                            <div id="ghx-operations">
                                <div id="ghx-controls">
                                    <div id="ghx-controls-plan" class="ghx-controls-plan ghx-controls-list"
                                         style="display: none;"></div>
                                    <div id="ghx-controls-work" class="ghx-controls-work ghx-controls-list">
                                        <div class="ghx-controls-filters js-quickfilter-selector">
                                            <dl id="js-work-quickfilters"
                                                class="aui-expander-content ghx-quick-content">
                                                <dt id="js-quickfilters-label" class="ghx-cursor-help"
                                                    title="Use Quick Filters to view a subset of issues. Board owners can add more.">
                                                    Quick Filters:
                                                </dt>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link first  "
                                                       title="Displays only WA_PET Tickets for specific duration (PET_LIVE_SUPPORT + PET_TECH_IMPROVMENT"
                                                       data-filter-id="13911" resolved="">Reports - Created in Last
                                                    week</a></dd>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link   "
                                                       title="assignee = Name.Name " data-filter-id="13090" resolved="">Name</a>
                                                </dd>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link   "
                                                       title="assignee = Name.Name " data-filter-id="13009" resolved="">Name</a>
                                                </dd>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link   "
                                                       title="Displays issues which are currently assigned to the current user"
                                                       data-filter-id="12956" resolved="">Only My Issues</a></dd>
                                                <dd><a role="button" href="#"
                                                       class="js-quickfilter-button aui-button aui-button-link  last "
                                                       title="Displays issues which have been updated in the last day"
                                                       data-filter-id="12957" resolved="">Recently Updated</a></dd>
                                                <dd class="ghx-quickfilter-trigger" style="display: none;"><a
                                                        id="js-work-quickfilters-trigger"
                                                        data-replace-text="Ã¢â‚¬Â¦ Show fewer"
                                                        class="aui-expander-trigger"
                                                        aria-controls="js-work-quickfilters">Ã¢â‚¬Â¦ Show more</a></dd>
                                            </dl>
                                        </div>
                                        <button class="aui-button ghx-compact-toggle js-compact-toggle"
                                                title="Show the header ( Z )" aria-label="Show the header" resolved="">
                                            <span class="aui-icon aui-icon aui-icon-small aui-iconfont-vid-full-screen-off"></span>
                                        </button>
                                    </div>
                                    <div id="ghx-controls-report" class="ghx-controls-report"
                                         style="display: none;"></div>
                                </div>
                            </div>
                            <div id="ghx-work" class="ghx-work">
                                <div id="ghx-pool-column">
                                    <div id="ghx-pool-wrapper">
                                        <div id="ghx-column-header-group" class="ghx-column-header-group ghx-has-stats">
                                            <ul id="ghx-column-headers" class="ghx-column-headers">
                                            </ul>
                                        </div>
                                        <div id="ghx-pool" data-skate-ignore="" class="ghx-has-swimlanes ghx-band-2"
                                             style="display: block;">
                                            {% if projectComponents|length > 0 %}
                                                <table id="projectComponentsTable"
                                                       class="table table-sm table-bordered table-hover">
                                                    <thead>
                                                    <tr>
                                                        <th>Component</th>
                                                        <th>Status</th>
                                                        <th>Issues</th>
                                                        <th>lead</th>
                                                        <th>Description</th>
                                                        <th>Action</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for component in projectComponents %}
                                                        <tr>
                                                            <td>
                                                                <a href="#">{{ component.internalKey }}</a>
                                                            </td>
                                                            <td>
                                                                <span class="badge"
                                                                      style="color: {{ component.status.fontColour }};background-color: {{ component.status.badgeColour }}">{{ component.status.internalKey }}</span>

                                                            </td>
                                                            <td>
                                                                <a href="#">{{ component.issues }} issues</a>
                                                            </td>
                                                            <td>
                                                                <img src={{ component.lead.icon }} width="25px"
                                                                     class="rounded-0">&nbsp;&nbsp;{{ component.lead.fullName }}
                                                            </td>
                                                            <td>
                                                                <p>{{ component.description }}</p>
                                                            </td>
                                                            <td>
                                                                <div class="dropdown">
                                                                    <button class="btn btn-sm btn-light"
                                                                            type="button" id="dropdownMenuButton"
                                                                            data-toggle="dropdown" aria-haspopup="true"
                                                                            aria-expanded="false">
                                                                        <i style='font-size:15px' class='fas'>&#xf141;</i>
                                                                    </button>
                                                                    <div class="dropdown-menu"
                                                                         aria-labelledby="dropdownMenuButton">
                                                                        <form method="post">
                                                                            {% csrf_token %}
                                                                        </form>
                                                                        <a class="dropdown-item" href="#" onclick="updateInternalKeyOptions({{ component.id }});editField({{ component.id }});">Edit</a>
                                                                        <a class="dropdown-item" href="#" onclick="submitArchiveProjectComponent({{ component.id }});">Archive</a>
                                                                        <a class="dropdown-item" href="#" onclick="submitDeleteProjectComponent({{ component.id }});">Delete</a>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            {% else %}
                                                <div class="alert alert-primary text-center" role="alert">
                                                    Looks like there's no project components yet. Create one.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="ghx-team"></div>
                        </div>
                    </div>
                    <div class="ghx-throbber"></div>
                </div>
            </main>
        </div>
    </div>
    </body>

    <script>

        function submitArchiveProjectComponent(componentId) {
            $('#archiveProjectComponentId').val(componentId);
            $('#submitArchiveProjectComponent').click();
        }

        function submitDeleteProjectComponent(componentId) {
            $('#deleteProjectComponentId').val(componentId);
            $('#submitDeleteProjectComponent').click();
        }

        function serializeProjectComponents() {
            let projectComponentsList = [];

            {% for component in projectComponents %}

                projectComponentsList.push({
                    id: '{{ component.id }}',
                    internalKey: '{{ component.internalKey }}',
                    description: '{{ component.description|linebreaksbr }}',
                })

            {% endfor %}

            return projectComponentsList;
        }

        let projectComponentsList = serializeProjectComponents();

        function updateInternalKeyOptions(componentId) {
            let options = '';

            for (const item of projectComponentsList) {
                let isSelected = componentId !== null && item.id.toString() === componentId.toString();
                options += isSelected ? `<option selected="selected">${item.internalKey}</option>` : `<option>${item.internalKey}</option>`;
            }
            $('.componentInternalKey').append(options)
            $('.componentInternalKey').select2({
                tags: true,
                width: '100%'
            });
        }

        function getInternalKeyAndDescription(componentId) {

            let requiredObject = null;
            {% for component in projectComponents %}

                if ({{ component.id }} === componentId) {
                    requiredObject = {
                        'internalKey': '{{ component.internalKey }}',
                        'description': '{{ component.description|linebreaksbr }}',
                    }
                    return requiredObject;
                }

            {% endfor %}

            return requiredObject;
        }

        function editField(componentId) {
            let iAndD = getInternalKeyAndDescription(componentId);

            if (iAndD == null)
                return;

            $('#internalKeyEdit').val(iAndD.internalKey);
            $('#descriptionEdit').val(iAndD.description.replaceAll('<br>', '\n'));
            $('#editComponentModal').modal('toggle');
        }
    </script>

{% endblock %}