{% extends "accounts/base.html" %}
{% load static %}
{% block content %}
    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardBacklogCSS1.css' %}">
    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardBacklogCSS5.css' %}">

    {#    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardBacklogCSS1.css' %}" media="all">#}
    {#    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardBacklogCSS2.css' %}"#}
    {#          data-wrm-key="gh-rapid-charts,-_super" data-wrm-batch-type="context" media="all">#}
    {#    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardBacklogCSS3.css' %}"#}
    {#          data-wrm-key="com.atlassian.jira.jira-tzdetect-plugin:tzdetect-banner-component"#}
    {#          data-wrm-batch-type="resource" media="all">#}
    {#    <link type="text/css" rel="stylesheet" href="{% static 'css/kanbanBoardBacklogCSS4.css' %}"#}
    {#          data-wrm-key="jira.global.look-and-feel,-_super" data-wrm-batch-type="context" media="all">#}
    {#   <link type="text/css" rel="stylesheet"#}
    {#          href="{% static 'css/kanbanBoardBacklogCSS5.css' %}?agile_global_admin_condition=true&amp;flexboards=true&amp;jag=true&amp;jaguser=true&amp;slack-enabled=true&amp;user-logged-in=true"#}
    {#          data-wrm-key="gh-rapid-plan,atl.general,greenhopper-rapid-non-gadget,jira.project.sidebar,atl.global,jira.global,jira.general,com.atlassian.jira.projects.sidebar.init,-_super"#}
    {#          data-wrm-batch-type="context" media="all">#}

    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <style>
        .dropdown-toggle::after {
            display: none;
        }
    </style>

    <body id="jira"
          class="aui-layout aui-theme-default ghx-agile ghx-rapid-views aui-page-sidebar aui-sidebar-collapsed ghx-scroll-columns ghx-sprint-support ghx-days-in-column-enabled ghx-mode-planning">

    <div id="page">
        <header id="header" role="banner">
            <a class="aui-skip-link" href="#main">Skip to main content</a><a class="aui-skip-link" href="#sidebar">Skip
            to sidebar</a>
        </header>
        <div id="announcement-banner" class="alertHeader">
        </div>
        <div id="content">
            <section class="aui-sidebar projects-sidebar fade-in" resolved="" aria-expanded="false" id="sidebar"
                     aria-label="Sidebar">
                <div class="aui-sidebar-wrapper" style="height: 583px;">
                    <div class="col" style="margin-top: 10px">

                        <ul class="navbar-nav mr-auto">
                            <li class="nav-item active">
                                <a class="nav-link" href="{% url 'jira:board-settings' url=board.url %}"
                                   data-toggle="tooltip"
                                   data-placement="right" title="Settings"><i style="font-size:24px"
                                                                              class="fa">&#xf085;</i></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'jira:board-page' url=board.url %}"
                                   data-toggle="tooltip"
                                   data-placement="right" title="Board"><i style='font-size:24px'
                                                                           class='far'>&#xf24d;</i></a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown" href="#" id="navbarDropdown" role="button"
                                   data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                   title="Boards in this project">
                                    <i style='font-size:24px'
                                       class='far'>&#xf24d;</i>
                                </a>
                                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    {% for otherBoard in boardsInProject %}
                                        <a class="dropdown-item"
                                           href="{{ otherBoard.getUrl }}">{{ otherBoard.internalKey }}</a>
                                    {% endfor %}
                                </div>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'jira:board-backlog' url=board.url %}"
                                   data-toggle="tooltip"
                                   data-placement="right" title="Backlog"><i style="font-size:24px"
                                                                             class="fas fa-tasks"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
            <main role="main" id="main" class="ghx-gh  aui-page-panel">

            </main>
        </div>
    </div>
    </body>

    <script type="text/javascript">

        // connectedSortable, draggable, sortable, listOfActiveTicketsContainer

        window.onload = function () {


            /*$("#draggable").draggable(
                {
                    connectToSortable: "#sortable",
                    helper: "clone",
                    revert: "invalid"
                }
            );*/

            $("ul, li").disableSelection();
        }

        $(function () {
            $('#listOfActiveTicketsContainer').sortable(
                {
                    stop: function (e, ui) {
                        const newOrder = $.map($('#listOfActiveTicketsContainer> div'), div => div.id);

                        {#$.ajax(#}
                        {#    {#}
                        {#        url: "{% url 'jira:ticketBulkOrderChangeApiEventVersion1Component' %}",#}
                        {#        data:#}
                        {#            {#}
                        {#                'newOrder': newOrder,#}
                        {#            },#}
                        {#        type: 'PUT',#}
                        {#        dataType: 'json',#}
                        {#    }#}
                        {#);#}
                    }
                }
            );
        });

    </script>
    <script type="text/babel">

        class BaseComponent extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {

            }
        }

        class EpicComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    colour: this.props.epic ? this.props.epic.colour : "white"
                }
            }

            render() {
                const style1 = {
                    backgroundColor: this.state.colour,
                    color: "black"
                }
                const style2 = {
                    marginTop: "-3px",
                }
                if (this.props.epic) {
                    return (
                        <h5 style={style2}><span className="badge" style={style1}>{this.props.epic.summary}</span></h5>
                    )
                } else {
                    return (
                        <span></span>
                    )
                }
            }
        }

        class KanbanBoardHeaderComponent extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {
                return (
                    <div id="ghx-header">
                        <div id="ghx-view-selector">
                            <h1>
                                <span className="subnav-container">
                                    <span id="subnav-title">
                                        <span className="subnavigator-title"
                                              title="Backlog"> {{ board.internalKey }} Backlog</span>
                                    </span>
                                </span>
                            </h1>
                        </div>
                    </div>
                )
            }
        }

        class UserComponent extends React.Component {
            constructor(props) {
                super(props);

                var cdnIcon = "https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png";

                this.state = {
                    name: this.props.user ? this.props.user.firstName + " " + this.props.user.lastName : "Unassigned",
                    icon: this.props.user ? this.props.user.icon : cdnIcon
                }
            }

            render() {
                const style2 = {
                    marginTop: "-11px",
                    marginLeft: "-10px"
                }
                if (this.props.user !== null) {
                    return (
                        <div className="col-auto" style={style2}>
                            <img src={this.state.icon} width="25" height="25" data-toggle="tooltip" data-placement="top"
                                 title={this.state.name}></img>
                        </div>
                    )
                } else {
                    return (
                        <span></span>
                    )
                }
            }
        }

        class UserComponent2 extends React.Component {
            constructor(props) {
                super(props);

                var cdnIcon = "https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png";

                this.state = {
                    name: this.props.user ? this.props.user.firstName + " " + this.props.user.lastName : "Unassigned",
                    icon: this.props.user ? this.props.user.icon : cdnIcon
                }
            }

            render() {

                if (this.props.user !== null) {
                    return (
                        <img src={this.state.icon} className="ghx-avatar-img" alt={this.state.name}
                             title={this.state.name}
                             loading="lazy"></img>
                    )
                } else {
                    return (
                        <span></span>
                    )
                }

            }
        }

        class TicketBar extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {
                const style1 = {
                    height: "10px",
                    cursor: "grab"
                }
                const style2 = {
                    marginTop: "-11px",
                    marginLeft: "-10px"
                }

                const style5 = {
                    marginTop: "-11px",
                    marginLeft: "-20px"
                }

                const style3 = {
                    marginTop: "-9px",
                    marginLeft: "-20px"
                }

                const style4 = {
                    backgroundColor: "#e7e7e7",
                    fontSize: "14px"
                }

                const style6 = {
                    color: "grey"
                }

                return (
                    <div className="card grabbable" id={this.props.ticket.id} data-issue-id={this.props.ticket.id}>
                        <div className="card-body" style={style1}>
                            <div className="row">
                                <div className="col-auto" style={style2}>
                                    <img src={this.props.ticket.issueType.icon} width="20" height="20"
                                         data-toggle="tooltip"
                                         data-placement="top" title={this.props.ticket.issueType.internalKey}></img>
                                </div>
                                <div className="col" style={style3}>
                                    <span>{this.props.ticket.summary}</span>
                                </div>
                                <div className="col-auto" style={style3}>
                                    <EpicComponent epic={this.props.ticket.epic}/>
                                </div>
                                <UserComponent user={this.props.ticket.assignee}/>
                                <div className="col-auto" style={style3}>
                                    {
                                        this.props.ticket.resolution.code === "RESOLVED" ?
                                            <del>
                                                <a style={style6}
                                                   href={this.props.ticket.link}>{this.props.ticket.internalKey}</a>
                                            </del>
                                            :
                                            <a style={style6}
                                               href={this.props.ticket.link}>{this.props.ticket.internalKey}</a>
                                    }
                                </div>
                                <div className="col-auto" style={style5}>
                                    <img src={this.props.ticket.priority.icon} width="20" height="20"
                                         data-toggle="tooltip"
                                         data-placement="top" title={this.props.ticket.priority.internalKey}></img>
                                </div>
                                <div className="col-auto" style={style5}>
                                    <span className="badge badge-pill badge-light"
                                          style={style4}>{this.props.ticket.storyPoints}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
        }

        class ClassificationComponent extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {
                return (
                    <span></span>
                )
            }
        }

        class QuickFiltersComponent extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {
                const style1 = {
                    display: "none"
                }
                return (
                    <div id="ghx-controls">
                        <div id="ghx-controls-plan" className="ghx-controls-plan ghx-controls-list"
                             style={style1}>
                        </div>
                        <div id="ghx-controls-work" className="ghx-controls-work ghx-controls-list">
                            <div className="ghx-controls-filters js-quickfilter-selector">
                                <dl id="js-work-quickfilters"
                                    className="aui-expander-content ghx-quick-content">
                                    <dt id="js-quickfilters-label" className="ghx-cursor-help"
                                        title="Use Quick Filters to view a subset of issues. Board owners can add more.">
                                        Quick Filters:
                                    </dt>
                                    <dd><a role="button" href="#"
                                           className="js-quickfilter-button aui-button aui-button-link first  "
                                           title="Displays only WA_PET Tickets for specific duration (PET_LIVE_SUPPORT + PET_TECH_IMPROVMENT"
                                           data-filter-id="13911" resolved="">Reports - Created in Last
                                        week</a></dd>
                                    <dd><a role="button" href="#"
                                           className="js-quickfilter-button aui-button aui-button-link   "
                                           title="assignee = Name.Name " data-filter-id="13090"
                                           resolved="">Name</a>
                                    </dd>
                                    <dd><a role="button" href="#"
                                           className="js-quickfilter-button aui-button aui-button-link   "
                                           title="assignee = Name.Name " data-filter-id="13009"
                                           resolved="">Name</a>
                                    </dd>
                                    <dd><a role="button" href="#"
                                           className="js-quickfilter-button aui-button aui-button-link   "
                                           title="Displays issues which are currently assigned to the current user"
                                           data-filter-id="12956" resolved="">Only My Issues</a></dd>
                                    <dd><a role="button" href="#"
                                           className="js-quickfilter-button aui-button aui-button-link  last "
                                           title="Displays issues which have been updated in the last day"
                                           data-filter-id="12957" resolved="">Recently Updated</a></dd>
                                    <dd className="ghx-quickfilter-trigger" style={style1}><a
                                        id="js-work-quickfilters-trigger"
                                        data-replace-text="Ã¢â‚¬Â¦ Show fewer"
                                        className="aui-expander-trigger"
                                        aria-controls="js-work-quickfilters">Ã¢â‚¬Â¦ Show more</a></dd>
                                </dl>
                            </div>
                            <button className="aui-button ghx-compact-toggle js-compact-toggle"
                                    title="Show the header ( Z )" aria-label="Show the header" resolved="">
                                            <span
                                                className="aui-icon aui-icon aui-icon-small aui-iconfont-vid-full-screen-off"></span>
                            </button>
                        </div>
                        <div id="ghx-controls-report" className="ghx-controls-report"
                             style={style1}></div>
                    </div>
                )
            }
        }

        class GroupComponent extends React.Component {
            constructor(props) {
                super(props);

                const Column = {
                    TO_DO: 'TO DO',
                    IN_PROGRESS: 'IN PROGRESS',
                    DONE: 'DONE',
                };

                let _notStartedPoints = 0;
                let _inProgressPoints = 0;
                let _completedPoints = 0;


                // collect unique assigned users.
                // calculate story points for metric.

                let workers = [];
                for (const ticket of this.props.group.tickets) {
                    if (ticket.assignee != null) {
                        workers.push(ticket.assignee);
                    }

                    if (typeof ticket.storyPoints === "number") {
                        let intPoint = parseInt(ticket.storyPoints);

                        if (ticket.column === Column.TO_DO)
                            _notStartedPoints += intPoint;
                        else if (ticket.column === Column.IN_PROGRESS)
                            _inProgressPoints += intPoint;
                        else if (ticket.column === Column.DONE)
                            _completedPoints += intPoint;
                    }

                }

                let uniqueWorkers = [...new Map(workers.map((m) => [m.id, m])).values()];

                this.state = {
                    assignedWorkers: uniqueWorkers,
                    activeStoryPoints: {
                        notStartedPoints: _notStartedPoints,
                        inProgressPoints: _inProgressPoints,
                        completedPoints: _completedPoints,
                        totalPoints: _notStartedPoints + _inProgressPoints + _completedPoints,
                    },
                    sprintOptionAllowed: !(this.props.group.id === 0 && this.props.group.internalKey === 'Backlog'),
                }

            }

            componentDidMount = () => {
                $(".connectedSortable").sortable(
                    {
                        // revert: true
                        connectWith: ".connectedSortable"
                    }
                ).disableSelection();

                $(".droppable").droppable({
                    drop: function (event, ui) {
                        const ticketId = ui.draggable.attr('data-issue-id');
                        const columnId = $(event.target).attr('columnid');

                        let ticketIds = $.map($(`#planGroupId-${columnId} > div`), div => div.id);
                        for (let i = 0; i < ticketIds.length; i++) {
                            if (ticketIds[i] === '')
                                ticketIds[i] = String(ticketId);
                        }

                        $.ajax(
                            {
                                url: "{% url 'jira:backlogDetailsApiEventVersion2Component' boardId=board.id%}",
                                data:
                                    {
                                        'columnId': columnId,
                                        'ticketIds': ticketIds,
                                    },
                                type: 'PUT',
                                dataType: 'json',
                            }
                        );
                    }
                });
            }

            completeSprint = (sprintId) => {

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this! Any un-done tickets will be moved to next sprint.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax(
                            {
                                url: "{% url 'jira:sprintObjectApiEventVersion1Component' boardId=board.id%}",
                                data:
                                    {
                                        'sprintId': sprintId,
                                        'function': "COMPLETE_SPRINT",
                                    },
                                type: 'PUT',
                                dataType: 'json',
                                success: function (response) {
                                    if (response.success) {
                                        window.location.reload();
                                    }
                                }
                            });

                    }
                })
            }

            startSprint = (sprintId) => {

                Swal.fire({
                    title: 'Are you sure you want to start this sprint?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire(
                            'Deleted!',
                            'Your file has been deleted.',
                            'success'
                        )
                    }
                })
            }

            deleteSprint = (sprintId) => {

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this! All the tickets will be moved to backlog",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes!'
                }).then((result) => {

                    if (result.isConfirmed) {
                        $.ajax(
                            {
                                url: "{% url 'jira:sprintObjectApiEventVersion1Component' boardId=board.id%}",
                                data:
                                    {
                                        'sprintId': sprintId,
                                        'function': "DELETE_SPRINT",
                                    },
                                type: 'PUT',
                                dataType: 'json',
                                success: function (response) {
                                    if (response.success) {
                                        window.location.reload();
                                    }
                                }
                            });

                    }

                })
            }


            render() {
                const style1 = {
                    minHeight: "50px",
                }
                const style2 = {
                    marginRight: "-15px",
                }
                return (
                    <div className="ghx-sprint-group">
                        <div data-sprint-id="9951"
                             className="ghx-backlog-container ghx-sprint-active js-sprint-container ghx-open ui-droppable">
                            <div className="ghx-backlog-header js-sprint-header" data-sprint-id="9951">
                                <button className="aui-button ghx-expander ghx-heading-expander" aria-expanded="true"
                                        title="Toggle swimlane visibility" data-toggle="collapse">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14">
                                        <g fill="none" fillRule="evenodd">
                                            <path
                                                d="M3.29175 4.793c-.389.392-.389 1.027 0 1.419l2.939 2.965c.218.215.5.322.779.322s.556-.107.769-.322l2.93-2.955c.388-.392.388-1.027 0-1.419-.389-.392-1.018-.392-1.406 0l-2.298 2.317-2.307-2.327c-.194-.195-.449-.293-.703-.293-.255 0-.51.098-.703.293z"
                                                fill="#344563"></path>
                                        </g>
                                    </svg>
                                </button>
                                <div className="ghx-name">
                                    <span className="field-value ghx-readonly">{this.props.group.internalKey}</span>
                                </div>
                                <div className="ghx-issue-count">
                                    <span id="activeTicketsCounter"> {this.props.group.tickets.length} </span> issues
                                </div>
                                {
                                    this.props.group.isActive ? <span
                                            className="active-sprint-lozenge aui-lozenge aui-lozenge-success">Active</span>
                                        :
                                        <span></span>
                                }

                                <div className="ghx-badge-group ghx-right">
                                    <aui-badge className="ghx-not-started"
                                               title={"Not Started: " + this.state.activeStoryPoints.notStartedPoints + " of " + this.state.activeStoryPoints.totalPoints + " (Story Points)"}>
                                        {this.state.activeStoryPoints.notStartedPoints}
                                    </aui-badge>
                                    <aui-badge className="ghx-in-progress"
                                               title={"In Progress: " + this.state.activeStoryPoints.inProgressPoints + " of " + this.state.activeStoryPoints.totalPoints + " (Story Points)"}>
                                        {this.state.activeStoryPoints.inProgressPoints}
                                    </aui-badge>
                                    <aui-badge className="ghx-done"
                                               title={"Done: " + this.state.activeStoryPoints.completedPoints + " of " + this.state.activeStoryPoints.totalPoints + " (Story Points)"}>
                                        {this.state.activeStoryPoints.completedPoints}
                                    </aui-badge>
                                </div>
                                <div className="ghx-sprint-info">
                                    <div className=" col ghx-assigned-work-stats">
                                        {this.state.assignedWorkers.map((worker) => <UserComponent2
                                            key={worker.id} user={worker}/>)}
                                    </div>
                                    {this.state.sprintOptionAllowed ? <div className="col-auto" style={style2}>
                                        <button type="button" className="btn aui-button dropdown-toggle"
                                                data-toggle="dropdown"
                                                aria-haspopup="true" aria-expanded="false">
                                            <i className='fas fa-ellipsis-h'></i>
                                        </button>
                                        <div className="dropdown-menu">
                                            {
                                                this.props.group.isActive ?
                                                    <a className="dropdown-item" onClick={() => {
                                                        this.completeSprint(this.props.group.id)
                                                    }}>Complete Sprint</a>
                                                    : <span><a className="dropdown-item" onClick={() => {
                                                        this.startSprint(this.props.group.id)
                                                    }}>Start Sprint</a>
                                        <a className="dropdown-item" onClick={() => {
                                            this.deleteSprint(this.props.group.id)
                                        }}>Delete Sprint</a></span>
                                            }


                                        </div>
                                    </div> : <span></span>
                                    }

                                </div>
                            </div>
                            <div className="ghx-meta ghx-disabled">
                                <div
                                    className="ghx-issues js-issue-list ghx-has-issues tickets connectedSortable ui-sortable droppable ui-droppable"
                                    style={style1}
                                    data-skate-ignore="" columnid={this.props.group.id}
                                    id={"planGroupId-" + this.props.group.id}>
                                    {this.props.group.tickets.map((ticket) => <TicketBar key={ticket.id}
                                                                                         ticket={ticket}/>)}
                                </div>
                            </div>
                        </div>
                        <br></br>
                        <br></br>
                    </div>)
            }
        }

        class KanbanBoardBacklogDetailView extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {
                return (
                    <div id="ghx-backlog-column" className="ghx-backlog-column">
                        <div id="ghx-backlog" className="ghx-backlog" data-loaded="1653826422372" data-load-time="385"
                             data-rendered="1653826422484" data-draw-time="149">
                            <div id="ghx-content-group" data-card-color-strategy="none" className="ui-sortable">

                                {this.props.backlogGroups.map((group) => <GroupComponent key={group.id}
                                                                                         group={group}/>)}
                                <br></br>
                                <br></br>
                                <br></br>
                                <br></br>
                            </div>
                        </div>
                    </div>
                )
            }
        }

        class EpicDetailsComponent extends React.Component {
            constructor(props) {
                super(props);

                const prog = this.props.ticket.statistics.completed === 0 ?
                0 : this.props.ticket.statistics.completed / this.props.ticket.statistics.issues;

                this.state = {
                    panelDetailVisibility: "none",
                    progress: prog * 100
                }
            }

            switchPanelDetailVisibility = () => {
                if (this.state.panelDetailVisibility === "none") {
                    this.setState({
                        panelDetailVisibility: ""
                    })
                } else {
                    this.setState({
                        panelDetailVisibility: "none"
                    })
                }
            }

            render() {
                const style4 = {
                    width: this.state.progress + "%"
                }
                const style2 = {
                    display: this.state.panelDetailVisibility
                }
                return (
                    <div
                        className="js-sortable ghx-classification-item ghx-label-4-border ui-droppable ghx-open"
                        data-epic-key={this.props.ticket.internalKey} data-epic-id={this.props.ticket.id}>
                        <div className="ghx-inner">
                            <button
                                className="aui-button aui-button-subtle ghx-expander ghx-heading-expander js-epic-details-toggle"
                                aria-expanded="true" title="Hide/show epic information">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                     onClick={this.switchPanelDetailVisibility}>
                                    <g fill="none" fillRule="evenodd">
                                        <path
                                            d="M3.29175 4.793c-.389.392-.389 1.027 0 1.419l2.939 2.965c.218.215.5.322.779.322s.556-.107.769-.322l2.93-2.955c.388-.392.388-1.027 0-1.419-.389-.392-1.018-.392-1.406 0l-2.298 2.317-2.307-2.327c-.194-.195-.449-.293-.703-.293-.255 0-.51.098-.703.293z"
                                            fill="#344563"></path>
                                    </g>
                                </svg>
                            </button>
                            <div className="ghx-header">
                                <h3 className="ghx-name">
                                    <span className="js-epic-name" role="button">
                                        <span className="field-value js-editable-field js-edit-epicLabel-trigger"
                                              data-fieldname="epicLabel"
                                              data-fieldvalue={this.props.ticket.summary}>{this.props.ticket.summary}
                                        </span>
                                    </span>
                                    <div id={"dd-trigger-" + this.props.ticket.internalKey}
                                         className="epic-more-button js-epic-actions"
                                         aria-controls={"dd-trigger-" + this.props.ticket.internalKey + "_drop"}
                                         aria-haspopup="true"
                                         aria-expanded="false"><span
                                        className="aui-icon aui-icon-small aui-iconfont-more"></span>
                                    </div>
                                </h3>
                            </div>

                            <div style={style2} className="ghx-expanded">
                                <div className="ghx-summary">
                                    <small>
                                        <a role="button" className="js-epic-key-link"
                                           title="View epic details"
                                           href={this.props.ticket.link}>{this.props.ticket.internalKey}</a>
                                        &nbsp;
                                        {this.props.ticket.summary}
                                    </small>

                                </div>
                                <div className="aui-group js-epic-issues-count ghx-issue-count">
                                    <div className="aui-item">Issues</div>
                                    <div className="aui-item">
                                        <aui-badge className="">{this.props.ticket.statistics.issues}</aui-badge>
                                    </div>
                                </div>
                                <div className="aui-group ghx-issue-count">
                                    <div className="aui-item">Not started</div>
                                    <div className="aui-item">
                                        <aui-badge className="">{this.props.ticket.statistics.notStarted}</aui-badge>
                                    </div>
                                </div>
                                <div className="aui-group js-epic-issues-count ghx-issue-count">
                                    <div className="aui-item">In progress</div>
                                    <div className="aui-item">
                                        <aui-badge className="">{this.props.ticket.statistics.inProgress}</aui-badge>
                                    </div>
                                </div>
                                <div className="aui-group ghx-issue-count">
                                    <div className="aui-item">Completed</div>
                                    <div className="aui-item">
                                        <aui-badge className="">{this.props.ticket.statistics.completed}</aui-badge>
                                    </div>
                                </div>
                                <div className="aui-group ghx-estimates">
                                    <div className="aui-item">Unestimated</div>
                                    <div className="aui-item">
                                        <aui-badge className="">{this.props.ticket.statistics.unEstimated}</aui-badge>
                                    </div>
                                </div>
                                <div className="aui-group ghx-estimates">
                                    <div className="aui-item">Estimated</div>
                                    <div className="aui-item">
                                        <aui-badge className="">{this.props.ticket.statistics.estimated}</aui-badge>
                                    </div>
                                </div>
                                <div className="aui-group">
                                    <button className="aui-button aui-button-link js-create-epic-issue"
                                            title="Create and assign an issue to this epic">Create
                                        issue in epic
                                    </button>
                                </div>
                            </div>


                            <div className="ghx-subheader">
                                <ul className="ghx-classification-progress"
                                    title="100% of estimated work done (40 of 40 Story Points)">
                                    <li className="ghx-implemented" style={style4}></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                )
            }
        }

        class PlanGroupComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    visibility: "none",
                    allIssuesVisibility: "none",
                    epicTickets: [],
                    showEpicLess: false,
                    backlogGroups: []
                }
            }


            showAllBacklogGroupsAllTicketsComponent = () => {
                fetch('{% url 'jira:backlogDetailsApiEventVersion2Component' boardId=board.id%}', {
                    method: 'GET',
                }).then((response) => response.json())
                    .then((json) => {
                        this.setState({
                            backlogGroups: json.data.backlogGroups
                        })
                    })
            }

            showBoardProjectsEpicsDetails = () => {
                fetch('{% url 'jira:epicDetailsForBoardApiEventVersion1Component' boardId=board.id%}', {
                    method: 'GET',
                }).then((response) => response.json())
                    .then((json) => {
                        this.setState({
                            epicTickets: json.data.epicTickets
                        })
                    })
            }

            showAllBacklogGroupsEpicLessTicketsComponent = () => {
                fetch('{% url 'jira:backlogDetailsEpicLessTicketsApiEventVersion1Component' boardId=board.id%}', {
                    method: 'GET',
                }).then((response) => response.json())
                    .then((json) => {
                        this.setState({
                            backlogGroups: json.data.backlogGroups
                        })
                    })
            }

            componentDidMount = () => {
                this.showAllBacklogGroupsAllTicketsComponent();
                this.showBoardProjectsEpicsDetails();
            }

            hideEpicPanel = () => {
                if (this.state.visibility === "none") {
                    this.setState({
                        visibility: ""
                    })
                } else {
                    this.setState({
                        visibility: "none"
                    })
                }
            }

            switchAllIssuesVisibility = () => {
                if (this.state.allIssuesVisibility === "none") {
                    this.setState({
                        allIssuesVisibility: ""
                    })
                } else {
                    this.setState({
                        allIssuesVisibility: "none"
                    })
                }
            }


            activateIssueWithoutEpics = () => {

                this.setState({
                    showEpicLess: !this.state.showEpicLess
                })

                if (!this.state.showEpicLess) {
                    this.showAllBacklogGroupsEpicLessTicketsComponent();
                } else {
                    this.showAllBacklogGroupsAllTicketsComponent();
                }
            }

            render() {

                const style1 = {
                    display: this.state.visibility
                }

                const style2 = {
                    fontSize: "15px"
                }
                const style3 = {
                    display: "none",
                    width: "400px",
                }

                const style4 = {
                    display: this.state.allIssuesVisibility,
                }

                return (
                    <div id="ghx-plan-group" className="ghx-plan-group ghx-epic-expanded">
                        <div id="ghx-classification-menu-column">
                            <ul id="ghx-classification-menu"
                                className="ghx-ide-menu ghx-classification-menu">
                                <li role="button" className="js-release-toggle ghx-release-toggle"
                                    title="Show versions panel<b>Use versions to keep track of code releases.</b>">
                                    <span className="ghx-inner">Versions</span></li>
                                {
                                    this.state.visibility === "none" ?
                                        <li onClick={this.hideEpicPanel} role="button"
                                            className="js-release-toggle ghx-release-toggle"
                                            title="Show versions panel<b>Use versions to keep track of code releases.</b>">
                                            <span className="ghx-inner">Epics</span></li> : <li></li>
                                }
                            </ul>
                        </div>
                        <div id="ghx-version-column"
                             className="ghx-version-column ghx-classification-column ghx-hidden"
                             data-skate-ignore=""></div>
                        <div id="ghx-epic-column" style={style1} className="ghx-epic-column ghx-classification-column"
                             data-skate-ignore="">
                            <div className="ghx-classification-group">
                                <div className="ghx-classification-header">
                                    <div className="ghx-actions">
                                        <div className="ghx-close js-epic-search" title="Filter epics">
                                            <button
                                                className="aui-button aui-button-subtle ghx-expander ghx-heading-expander js-epic-search-toggle"
                                                aria-expanded="true" title="Filter epics">
                                                <i style={style2} className="fa">&#xf002;</i>
                                            </button>
                                        </div>
                                        <div className="ghx-add-button js-create-epic"
                                             title="Create epic">
                                            <button
                                                className="aui-button aui-button-subtle ghx-expander ghx-heading-expander js-epic-create-toggle"
                                                aria-expanded="true" title="Create epic">
                                                <i style={style2} className="fa">&#xf067;</i>
                                            </button>
                                        </div>
                                        <div className="ghx-close js-epic-toggle" onClick={this.hideEpicPanel}
                                             title="Hide epics panel">
                                            <button
                                                className="aui-button aui-button-subtle ghx-expander ghx-heading-expander js-epic-hide-toggle"
                                                aria-expanded="true" title="Hide epics panel">
                                                <i style={style2} className="fa">&#xf00d;</i>
                                            </button>
                                        </div>
                                    </div>
                                    <h2>Epics</h2>
                                </div>
                                <div className="ghx-progress-indicator ghx-initial"></div>
                                <form className="aui epic-search-wrapper">
                                    <div className="gh-input-with-icon">
                                        <input className="text long-field"
                                               type="text"
                                               id="epic-search"></input>
                                        <span
                                            id="js-epic-search-icon"
                                            className="aui-icon ghx-iconfont aui-icon-small aui-iconfont-search-small"></span>
                                    </div>
                                </form>
                                <div className="ghx-classification-scrollview">
                                    <div
                                        className="ghx-classification-item ghx-classification-all  ghx-selected"
                                        onClick={this.switchAllIssuesVisibility}>
                                        <div className="ghx-inner">
                                            <div className="ghx-header">
                                                <h3 className="ghx-name">
                                                                <span className="js-epic-name"
                                                                      role="button">All issues</span>
                                                </h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="ghx-classification-cards ui-sortable" style={style4}>

                                        {this.state.epicTickets.map((ticket) => <EpicDetailsComponent key={ticket.id}
                                                                                                      ticket={ticket}/>)}

                                    </div>
                                    <div onClick={this.activateIssueWithoutEpics}
                                         className="ghx-classification-item ghx-classification-pending ui-droppable"
                                         data-epic-key="none">
                                        <div className="ghx-inner">
                                            <div className="ghx-header">
                                                <h3 className="ghx-name">
                                                    <span className="js-epic-name" role="button">
                                                        {
                                                            !this.state.showEpicLess ? "Show issues without epics" : "Show all tickets"
                                                        }
                                                    </span>
                                                </h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <KanbanBoardBacklogDetailView backlogGroups={this.state.backlogGroups}/>

                        <div id="ghx-detail-view" className="ghx-detail-view gh-editable-detail-view"
                             style={style3}></div>
                    </div>
                )
            }
        }

        class KanbanBoardMainComponent extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {
                const style1 = {
                    display: "none"
                }
                const style2 = {
                    display: "block"
                }

                return (
                    <div id="ghx-content-main" className="ghx-content-main">
                        <div id="ghx-errors"></div>
                        <div id="ghx-notify" style={style1}></div>
                        <div id="ghx-rabid">
                            <div id="ghx-operations">
                                <QuickFiltersComponent/>
                            </div>
                            <div id="ghx-plan" style={style2}>
                                <PlanGroupComponent/>
                            </div>
                            <div id="ghx-report" className="ghx-chart" style={style1}></div>
                            <div id="ghx-work" className="ghx-work" style={style1}></div>
                            <div id="ghx-team"></div>
                        </div>
                    </div>
                )
            }

        }

        class KanbanBoardBodyComponent extends React.Component {
            constructor(props) {
                super(props);
            }

            render() {

                return (
                    <div id="gh" className="ghx-no-touch">
                        <KanbanBoardHeaderComponent/>
                        <KanbanBoardMainComponent/>
                    </div>
                )
            }
        }

        ReactDOM.render(<KanbanBoardBodyComponent/>, document.getElementById('main'));
    </script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
{% endblock %}