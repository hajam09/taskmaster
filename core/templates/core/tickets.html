{% extends "core/base.html" %}
{% load crispy_forms_filters %}
{% load static %}
{% load crispy_forms_tags %}
{% load templateTags %}
{% block content %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/avatars-icons.css' %}"/>
    <div class="container-fluid justify-content-center mt-5 mb-5" style="color: black;">
        <div class="card idCardWideComponent">
            <legend>
                <h2 class="heading-h2 text-center">Tickets</h2>
            </legend>

            <span class="form-row align-items-center mt-4 flex-nowrap">

                <div class="col-2">
                    <input type="text" name="query" class="form-control form-control-sm" placeholder="Search"
                           value="{{ request.GET.query }}">
                </div>

                <div class="col"></div>

                <div class="col-1 filter-dropdown d-none" data-filter="type">
                    <select name="type" class="form-control form-control-sm"></select>
                </div>

                <div class="col-1 filter-dropdown d-none" data-filter="priority">
                    <select name="priority" class="form-control form-control-sm"></select>
                </div>

                <div class="col-1 filter-dropdown d-none" data-filter="status">
                    <select name="status" class="form-control form-control-sm"></select>
                </div>

                <div class="col-1 filter-dropdown d-none" data-filter="resolution">
                    <select name="resolution" class="form-control form-control-sm"></select>
                </div>

                <div class="col-1 filter-dropdown d-none" data-filter="project">
                    <select name="project" class="form-control form-control-sm"></select>
                </div>

                <div class="col-1 filter-dropdown d-none" data-filter="assignee">
                    <select name="assignee" class="form-control form-control-sm"></select>
                </div>

                <div class="col-1 filter-dropdown d-none" data-filter="reporter">
                    <select name="reporter" class="form-control form-control-sm"></select>
                </div>

                <!-- Push next items to far right -->
                <div class="ms-auto col-2">
                    <select id="filter-toggle" class="form-control form-control-sm">
                        <option value="">Filter</option>
                        <option value="type">‚òê Type</option>
                        <option value="priority">‚òê Priority</option>
                        <option value="status">‚òê Status</option>
                        <option value="resolution">‚òê Resolution</option>
                        <option value="project">‚òê Project</option>
                        <option value="assignee">‚òê Assignee</option>
                        <option value="reporter">‚òê Reporter</option>
                    </select>
                </div>

                <div class="col-auto">
                    <button type="button" class="btn btn-sm btn-submit">
                        Search
                    </button>
                </div>

            </span>
            <table id="ticketsTable" class="table table-sm table-bordered table-hover display nowrap"
                   style="width: 100%">
                <thead>
                <tr>
                    <th>T</th>
                    <th>Key</th>
                    <th>Summary</th>
                    <th>Assignee</th>
                    <th>Reporter</th>
                    <th>P</th>
                    <th>Status</th>
                    <th>Resolution</th>
                    <th>Labels</th>
                    <th>Created date</th>
                    <th>Updated Date</th>
                </tr>
                </thead>
                <tbody>
                {% for ticket in tickets %}
                    <tr>
                        <td>
                            <img src="{{ ticket.ticketTypeIcon }}" width="20px"
                                 title={{ ticket.get_type_display }} class="img-rounded" loading="lazy"
                                 style="margin-left: 10px"/>
                            <span style="display: none;">{{ ticket.get_type_display }}</span>
                        </td>
                        <td>{{ ticket.url }}</td>
                        <td>
                            <a href="{{ ticket.getUrl }}">{{ ticket.summary }}</a>
                        </td>
                        <td>
                            {% renderSingleOrGroupUserAvatars ticket.assignee %}
                        </td>
                        <td>
                            {% renderSingleOrGroupUserAvatars ticket.reporter %}
                        </td>
                        <td>
                            <img src="{{ ticket.ticketPriorityIcon }}" width="20px"
                                 title={{ ticket.get_priority_display }} class="img-rounded" loading="lazy"
                                 style="margin-left: 10px"/>
                            <span style="display: none;">{{ ticket.get_priority_display }}</span>
                        </td>
                        <td>
                            <h6>
                                <span class="badge"
                                      style="background-color: {{ ticket.columnStatus.column.getColour }}; color: white;">
                                    {{ ticket.columnStatus.name }}
                                </span>
                            </h6>
                        </td>
                        <td>{{ ticket.get_resolution_display }}</td>
                        <td>
                            {% for label in ticket.label.all %}
                                <a href="#"
                                   class="badge badge-light border"
                                   style="background-color: {{ label.colour }}; color: white">{{ label.name }}</a>
                            {% endfor %}
                        </td>
                        <td>{{ ticket.createdDateTime|date:"d M Y" }}</td>
                        <td>{{ ticket.modifiedDateTime|date:"d M Y" }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            {% paginationComponent request tickets %}
        </div>
    </div>

    <script type="application/javascript">
        document.addEventListener('DOMContentLoaded', function () {

            const selectedOptionsMap = {}; // Track selections per dropdown
            const searchInput = document.querySelector('[name="query"]');
            const searchBtn = document.querySelector('.btn-submit');

            // -------------------------------
            // Utility functions
            // -------------------------------
            function populateSelectFromJSON(selectEl, items) {
                if (!selectEl || !Array.isArray(items)) return;
                selectEl.innerHTML = '';
                items.forEach(item => {
                    if (item.key !== undefined && item.value !== undefined) {
                        const option = document.createElement('option');
                        option.value = item.key;
                        option.text = item.value;
                        selectEl.appendChild(option);
                    }
                });
            }

            function capitalizeFirstLetter(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            // -------------------------------
            // Initialize filter style & tick logic
            // -------------------------------
            function initFilterStyle(selectEl) {
                const name = selectEl.name;
                if (!selectedOptionsMap[name]) selectedOptionsMap[name] = new Set();

                const placeholder = selectEl.options[0];
                placeholder.dataset.defaultText = placeholder.text;

                selectEl.addEventListener('change', function () {
                    const value = this.value;
                    if (!value) return;

                    // Toggle selection
                    if (selectedOptionsMap[name].has(value)) {
                        selectedOptionsMap[name].delete(value);
                    } else {
                        selectedOptionsMap[name].add(value);
                    }

                    // Update option checkmarks
                    Array.from(this.options).forEach(opt => {
                        if (!opt.value) return;
                        if (selectedOptionsMap[name].has(opt.value)) {
                            opt.text = 'üóπ ' + opt.text.replace(/^üóπ |^‚òê /, '');
                            opt.setAttribute('checked', 'true');
                        } else {
                            opt.text = opt.text.replace(/^üóπ |^‚òê /, '');
                            opt.setAttribute('checked', 'false');
                        }
                    });

                    // Update dropdown placeholder text: Name (count)
                    const count = selectedOptionsMap[name].size;
                    placeholder.text = count > 0 ? `${capitalizeFirstLetter(name)} (${count})` : placeholder.dataset.defaultText;

                    // Keep placeholder selected
                    selectEl.selectedIndex = 0;

                    // Update filter-toggle option and main placeholder
                    updateFilterToggleOption(name);
                    updateFilterTogglePlaceholder();
                });
            }

            // -------------------------------
            // Preselect dropdown values from URL
            // -------------------------------
            function preselectFromURL(selectEl) {
                const urlParams = new URLSearchParams(window.location.search);
                const name = selectEl.name;
                if (!urlParams.has(name)) return;

                const values = urlParams.get(name).split(',');
                if (values.length === 0) return;

                if (!selectedOptionsMap[name]) selectedOptionsMap[name] = new Set();
                values.forEach(v => selectedOptionsMap[name].add(v));

                Array.from(selectEl.options).forEach(opt => {
                    if (!opt.value) return;
                    if (selectedOptionsMap[name].has(opt.value)) {
                        opt.text = 'üóπ ' + opt.text.replace(/^üóπ |^‚òê /, '');
                        opt.setAttribute('checked', 'true');
                    } else {
                        opt.text = opt.text.replace(/^üóπ |^‚òê /, '');
                        opt.setAttribute('checked', 'false');
                    }
                });

                const placeholder = selectEl.options[0];
                const count = selectedOptionsMap[name].size;
                placeholder.text = count > 0 ? `${capitalizeFirstLetter(name)} (${count})` : placeholder.dataset.defaultText;

                // Make dropdown visible
                const parent = selectEl.closest('.filter-dropdown');
                if (parent) parent.classList.remove('d-none');

                // Update filter-toggle option and main placeholder
                updateFilterToggleOption(name);
                updateFilterTogglePlaceholder();
            }

            // -------------------------------
            // Populate dropdown via API & preselect
            // -------------------------------
            function populateAndPreselect(selectEl) {
                const urlMap = {
                    'type': '{% url "core:ticketTypeListApiVersion1" %}',
                    'priority': '{% url "core:ticketPriorityListApiVersion1" %}',
                    'status': '{% url "core:columnStatusListApiVersion1" %}',
                    'resolution': '{% url "core:resolutionListApiVersion1" %}',
                    'project': '{% url "core:projectListApiVersion1" %}',
                    'assignee': '{% url "core:userListApiVersion1" %}',
                    'reporter': '{% url "core:userListApiVersion1" %}',
                };

                if (!(selectEl.name in urlMap)) return;

                fetch(urlMap[selectEl.name])
                    .then(response => response.json())
                    .then(data => {
                        const placeholder = {key: '', value: capitalizeFirstLetter(selectEl.name)};
                        if (selectEl.name === 'type') placeholder.value = 'Type';
                        else if (selectEl.name === 'priority') placeholder.value = 'Priority';
                        else if (selectEl.name === 'status') placeholder.value = 'Status';
                        else if (selectEl.name === 'resolution') placeholder.value = 'Resolution';
                        else if (selectEl.name === 'project') placeholder.value = 'Project';
                        data.unshift(placeholder);

                        populateSelectFromJSON(selectEl, data);
                        initFilterStyle(selectEl);
                        preselectFromURL(selectEl);
                    });
            }

            // -------------------------------
            // Update filter-toggle option for a single dropdown
            // -------------------------------
            function updateFilterToggleOption(name) {
                const filterToggle = document.getElementById('filter-toggle');
                const selectedSet = selectedOptionsMap[name];
                const option = Array.from(filterToggle.options).find(o => o.value === name);
                if (option) {
                    const count = selectedSet ? selectedSet.size : 0;
                    option.text = count > 0 ? 'üóπ ' + capitalizeFirstLetter(name) + ` (${count})` : '‚òê ' + capitalizeFirstLetter(name);
                }
            }

            // -------------------------------
            // Update the top placeholder (Filter) with total number of dropdowns that have selections
            // -------------------------------
            function updateFilterTogglePlaceholder() {
                const filterToggle = document.getElementById('filter-toggle');
                const placeholder = filterToggle.options[0];
                const totalSelectedDropdowns = Object.values(selectedOptionsMap).filter(set => set.size > 0).length;
                placeholder.text = totalSelectedDropdowns > 0 ? `Filter (${totalSelectedDropdowns})` : 'Filter';
            }

            // -------------------------------
            // Initialize filter toggle
            // -------------------------------
            function initialiseFilterToggle() {
                const filterToggle = document.getElementById('filter-toggle');

                filterToggle.addEventListener('change', function () {
                    const selected = this.value;
                    if (!selected) return;

                    const filterEl = document.querySelector(`.filter-dropdown[data-filter="${selected}"]`);
                    if (filterEl) filterEl.classList.toggle('d-none');

                    // Update option text and top placeholder
                    updateFilterToggleOption(selected);
                    updateFilterTogglePlaceholder();

                    this.selectedIndex = 0;
                });

                // Initialize all options on load
                Array.from(filterToggle.options).forEach(opt => {
                    if (!opt.value) return;
                    updateFilterToggleOption(opt.value);
                });

                // Update placeholder
                updateFilterTogglePlaceholder();
            }

            initialiseFilterToggle();

            // -------------------------------
            // Initialize all filters
            // -------------------------------
            document.querySelectorAll('.filter-dropdown select').forEach(selectEl => {
                if (selectEl.id !== 'filter-toggle') {
                    populateAndPreselect(selectEl);
                }
            });

            // -------------------------------
            // DataTable
            // -------------------------------
            $("#ticketsTable").DataTable({
                responsive: true,
                autoWidth: true,
                paging: false,
                searching: false,
                ordering: true,
                info: false,
                scrollX: true,
            });

            // -------------------------------
            // Search logic
            // -------------------------------
            function runSearch() {
                const query = searchInput.value.trim();
                const ticketsView = '{% url "core:tickets-view" %}';
                const filters = {};
                Object.keys(selectedOptionsMap).forEach(filterName => {
                    const selectedSet = selectedOptionsMap[filterName];
                    if (selectedSet && selectedSet.size > 0) filters[filterName] = Array.from(selectedSet);
                });

                const urlParams = new URLSearchParams();
                if (query) urlParams.append('query', query);
                Object.keys(filters).forEach(key => urlParams.append(key, filters[key].join(',')));

                window.location.href = `${ticketsView}?${urlParams.toString()}`;
            }

            searchInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    runSearch();
                }
            });

            searchBtn.addEventListener('click', runSearch);

        });
    </script>
{% endblock %}
