{% extends "core/base.html" %}
{% load crispy_forms_filters %}
{% load static %}
{% load crispy_forms_tags %}
{% load templateTags %}
{% block content %}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js" crossorigin="anonymous"></script>

    <div class="container-fluid mt-4" style="max-width: 1600px">

        <div class="card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="col-md-auto">
                    <img src="{{ ticket.getIcon }}" height="100" width="100">
                </div>
                <div class="col">
                    <a href="#"> {{ ticket.project.name }}</a> / <a href={{ ticket.getUrl }}> {{ ticket.url }}</a>
                    <h4 class="mb-0">{{ ticket.summary }}</h4>
                </div>
            </div>
        </div>

        <div class="btn-group mt-2" role="group">
            <button class="btn btn-sm btn-outline-primary mr-1">
                <i class="fa fa-paperclip"></i> Attach
            </button>
            <button class="btn btn-sm btn-outline-secondary mr-1">
                <i class="fa fa-edit"></i> Edit
            </button>
            <form method="post" class="d-inline"
                  onsubmit="return confirm('Are you sure you want to delete this ticket?');">
                {% csrf_token %}
                <input name="delete-ticket" hidden=>
                <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="fa fa-trash"></i> Delete
                </button>
            </form>
        </div>

        <div class="row mt-4">

            <div class="col-lg-8">

                <div class="card">
                    <div class="card-body">
                        <div class="collapse-header font-weight-bold" data-toggle="collapse"
                             data-target="#descriptionPanel">
                            Description
                            <span class="float-right">▼</span>
                        </div>

                        <div id="descriptionPanel" class="collapse show mt-3">
                            <div id="descriptionDisplay">
                                {% if ticket.description|length > 1000 %}
                                    <span id="shortDescription">{{ ticket.description|slice:":1000"|linebreaks }}</span>
                                    <span id="fullDescription" class="d-none">{{ ticket.description|linebreaks }}</span>
                                    <a href="#" id="toggleDescription">Show more</a>
                                {% else %}
                                    {{ ticket.description|default:"No description."|linebreaks }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% if ticket.type == 'EPIC' %}

                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="collapse-header font-weight-bold" data-toggle="collapse"
                                 data-target="#epicTicketsPanel">
                                Issues in this epic
                                <span class="float-right">▼</span>
                            </div>

                            {% if epicProgress %}
                                <div class="my-3">
                                    <div class="mb-2">
                                        <small>{{ epicProgress.done }} of {{ epicProgress.total }} done</small>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                             role="progressbar"
                                             aria-valuenow="{{ epicProgress.percent }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"
                                             style="width: {{ epicProgress.percent }}%;">
                                            {{ epicProgress.percent }}%
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <div id="epicTicketsPanel" class="collapse show mt-3">
                                <div id="epicTicketsList">
                                    {% for et in ticket.epicTickets.all %}
                                        {% ticketHorizontalBarComponent et False %}
                                        {% empty %}
                                        <i>No issues found for ths epic!</i>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                {% else %}

                    {% if ticket.ticketSubTask %}
                        {% for pt in ticket.ticketSubTask.all %}
                            <div class="card mt-4">
                                <div class="card-body">
                                    <div class="collapse-header font-weight-bold" data-toggle="collapse"
                                         data-target="#parentTaskTicketsPanel">
                                        {% if forloop.first %}
                                            Other subtasks - All subtasks of the parent issue
                                            <a href="{{ pt.getUrl }}">{{ pt.url }}</a>
                                        {% endif %}

                                        <span class="float-right">▼</span>
                                    </div>

                                    <div id="parentTaskTicketsPanel" class="collapse show mt-3">
                                        <div id="subtaskList">
                                            {% for st in pt.subTask.all %}
                                                {% if st != ticket %}
                                                    {% ticketHorizontalBarComponent st %}
                                                {% endif %}
                                                {% empty %}
                                                <i>No subtasks available for this ticket!</i>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}


                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="collapse-header font-weight-bold" data-toggle="collapse"
                                 data-target="#subTasksPanel">
                                Subtasks
                                <span class="float-right">▼</span>
                            </div>

                            {% if subTaskProgress %}
                                <div class="my-3">
                                    <div class="mb-2">
                                        <small>{{ subTaskProgress.done }} of {{ subTaskProgress.total }} done</small>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                             role="progressbar"
                                             aria-valuenow="{{ subTaskProgress.percent }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"
                                             style="width: {{ subTaskProgress.percent }}%;">
                                            {{ subTaskProgress.percent }}%
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <div id="subTasksPanel" class="collapse show mt-3">
                                <form method="post">
                                    {% csrf_token %}
                                    <input name="create-new-subtask" hidden>
                                    <div class="form-row">
                                        <div class="col-12 col-md mb-2">
                                            <input type="text" class="form-control form-control-sm w-100"
                                                   name="task-name" placeholder="Create new subtask" required>
                                        </div>
                                        <div class="col-auto mb-2">
                                            <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                        </div>
                                    </div>
                                </form>

                                <form method="post">
                                    {% csrf_token %}
                                    <input name="add-subtasks" hidden>
                                    <div class="form-row">
                                        <div class="col-12 col-md mb-2">
                                            <input type="text" class="form-control form-control-sm w-100"
                                                   placeholder="Add existing subtasks... ticket-1, ticket-2, ..."
                                                   name="task-ids" required>
                                        </div>
                                        <div class="col-auto mb-2">
                                            <button type="submit" class="btn btn-primary btn-sm">Add</button>
                                        </div>
                                    </div>
                                </form>

                                <div id="subtaskList">
                                    {% for st in ticket.subTask.all %}
                                        {% ticketHorizontalBarComponent st %}
                                        {% empty %}
                                        <i>No subtasks available for this ticket!</i>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="collapse-header font-weight-bold" data-toggle="collapse"
                                 data-target="#linkedIssuesPanel">
                                Linked Issues
                                <span class="float-right">▼</span>
                            </div>

                            <div id="linkedIssuesPanel" class="collapse show mt-3">
                                <form method="post">
                                    {% csrf_token %}
                                    <input name="add-linked-issue" hidden>

                                    <div class="form-row align-items-center">
                                        <div class="col-auto mb-2">
                                            <select name="link-type" class="form-control form-control-sm">
                                                {% for value, label in linkTypeChoices %}
                                                    <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="col mb-2">
                                            <input type="text" class="form-control form-control-sm" name="task-ids"
                                                   placeholder="Add issues ... ticket-1, ticket-2, ..." required>
                                        </div>

                                        <div class="col-auto mb-2">
                                            <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                        </div>
                                    </div>
                                </form>

                                <div id="linkedIssuesList">
                                </div>
                            </div>
                        </div>
                    </div>

                {% endif %}


                <div class="card mt-4">
                    <div class="card-body">
                        <div class="collapse-header font-weight-bold" data-toggle="collapse"
                             data-target="#activityPanel">
                            Activity
                            <span class="float-right">▼</span>
                        </div>

                        <div class="activity-tabs mb-3">
                            <button class="active">Comments</button>
                            <button>History</button>
                            <button>Worklog</button>
                        </div>

                        <div id="activityPanel" class="collapse show mt-3">
                            {% for c in ticket.ticketComments.all %}
                                <div class="comment-item">
                                    <strong>{{ c.creator.get_full_name }}</strong><br>
                                    <small>{{ c.createdDateTime|date:"Y-m-d H:i" }}</small>
                                    <p class="mt-1">{{ c.comment }}</p>
                                </div>
                                {% empty %}
                                <p class="text-muted">No comments yet.</p>
                            {% endfor %}

                            <form method="POST" class="mt-3">{% csrf_token %}
                                <textarea name="comment_text" class="form-control" rows="3"
                                          placeholder="Add a comment..."></textarea>

                                <div class="form-group">
                                    <label for="markdown">Markdown Content</label>
                                    <textarea class="form-control" id="markdown" rows="6"
                                              placeholder="Write Markdown here..."></textarea>
                                </div>
                                <button class="btn btn-primary btn-sm mt-2">Post Comment</button>
                            </form>
                        </div>

                    </div>
                </div>

            </div>

            <div class="col-lg-4">
                <div class="card">
                    <h5 class="card-header text-dark mb-4 font-weight-bold">Details</h5>
                    <div class="card-body">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>Type</strong>
                                <div>
                                    <img src="{{ ticket.ticketTypeIcon }}" width="20">
                                    {{ ticket.get_type_display }}
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Priority</strong>
                                <div>
                                    <img src="{{ ticket.ticketPriorityIcon }}" width="20">
                                    {{ ticket.get_priority_display }}
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong>Assignee</strong>
                                <div>
                                    <img src="https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png"
                                         width="20">
                                    {% if ticket.assignee %}{{ ticket.assignee.get_full_name }} {% else %}
                                        <span class="text-muted">Unassigned</span>{% endif %}
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Reporter</strong>
                                <div>
                                    <img src="https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png"
                                         width="20">
                                    {{ ticket.reporter.get_full_name }}
                                </div>
                            </div>


                            <div class="col-md-6 mb-3">
                                <strong>Status</strong>
                                <div>
                                    <span class="badge text-light"
                                          style="background-color: {{ ticket.columnStatus.column.getColour }}">{{ ticket.columnStatus.name }}</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Resolution</strong>
                                <div>
                                    {{ ticket.get_resolution_display }}
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong>Votes</strong>
                                <div>
                                    <span class="badge badge-light">0</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Watchers</strong>
                                <div>
                                    <span class="badge badge-light">0</span>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong>Created</strong>
                                <div>
                                    {{ ticket.createdDateTime|date:"d/m/y, H:i" }}
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Updated</strong>
                                <div>
                                    {{ ticket.modifiedDateTime|date:"d/m/y, H:i" }}
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong>Team</strong>
                                <div>
                                    TODO
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Sprint</strong>
                                <div>
                                    TODO
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong>Labels</strong>
                                <div>
                                    TODO
                                </div>
                            </div>
                            {% if ticket.epic %}
                                <div class="col-md-6 mb-3">
                                    <strong>Epic</strong>
                                    <div>
                                        <div>
                                            <img src="{{ ticket.epic.ticketTypeIcon }}" width="20">
                                            <a href="{{ ticket.epic.getUrl }}">
                                                {{ ticket.epic.summary|truncatechars:10 }}</a>
                                        </div>
                                    </div>
                                </div>
                            {% elif ticket.ticketSubTask %}
                                {% for pt in ticket.ticketSubTask.all %}
                                    {% if forloop.first %}
                                        <div class="col-md-6 mb-3">
                                            <strong>Parent</strong>
                                            <div>
                                                <div>
                                                    <img src="{{ pt.ticketTypeIcon }}" width="20">
                                                    <a href="{{ pt.getUrl }}">
                                                        {{ pt.summary|truncatechars:10 }}</a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}

                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>

        document.addEventListener("DOMContentLoaded", function () {
            const toggleLink = document.getElementById("toggleDescription");
            if (toggleLink) {
                const shortDesc = document.getElementById("shortDescription");
                const fullDesc = document.getElementById("fullDescription");

                toggleLink.addEventListener("click", function (e) {
                    e.preventDefault();
                    if (fullDesc.classList.contains("d-none")) {
                        fullDesc.classList.remove("d-none");
                        shortDesc.classList.add("d-none");
                        toggleLink.textContent = "Show less";
                    } else {
                        fullDesc.classList.add("d-none");
                        shortDesc.classList.remove("d-none");
                        toggleLink.textContent = "Show more";
                    }
                });
            }

            makeSortable('epicTicketsList');
            makeSortable('subtaskList');
            makeSortable('linkedIssuesList');
        });

        function makeSortable(listId) {
            const el = document.getElementById(listId);
            if (!el) return;  // Skip if the element doesn't exist

            new Sortable(el, {
                animation: 150,
                onEnd: function () {
                    const identifiers = Array.from(
                        el.querySelectorAll('li[identifier]')
                    ).map(li => li.getAttribute('identifier'));

                    fetch('{% url "core:ticketOrderNoUpdateApiV1" %}', {
                        method: 'PUT',
                        headers: {
                            'Content-type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(identifiers)
                    });
                }
            });
        }

    </script>
{% endblock %}
